<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Propina</title>
    <!-- Librer√≠as Externas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root{--menu-width:250px;--primary-color:#3498db;--primary-hover-color:#2980b9;--secondary-color:#2ecc71;--danger-color:#e74c3c;--warning-color:#f39c12;--light-bg:#eef2f6;--white-bg:#fff;--text-dark:#2c3e50;--text-light:#555;--border-color:#e0e6ed}body{font-family:'Poppins',sans-serif;margin:0;background-color:var(--light-bg);color:#333}.menu-toggle{position:fixed;top:15px;left:15px;z-index:1002;width:40px;height:40px;background-color:var(--primary-color);border:none;border-radius:8px;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.1);transition:left .3s ease}.menu-toggle span{display:block;width:22px;height:2px;background-color:#fff;margin:2px 0;transition:all .3s ease}.side-menu.open+.main-container .menu-toggle{left:calc(var(--menu-width) + 15px)}.menu-toggle.active span:nth-child(1){transform:translateY(6px) rotate(45deg)}.menu-toggle.active span:nth-child(2){opacity:0}.menu-toggle.active span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}.side-menu{position:fixed;top:0;left:0;width:var(--menu-width);height:100%;background-color:var(--text-dark);z-index:1001;transform:translateX(-100%);transition:transform .3s ease;display:flex;flex-direction:column;padding-top:60px;box-shadow:5px 0 15px rgba(0,0,0,.1)}.side-menu.open{transform:translateX(0)}.side-menu .menu-header{color:#fff;font-size:1.5em;font-weight:700;text-align:center;padding:20px 10px;border-bottom:1px solid #4a627a}.side-menu a{color:#fff;text-decoration:none;padding:15px 20px;display:block;font-size:1em;transition:background-color .2s ease,padding-left .2s ease;border-bottom:1px solid #3e5268}.side-menu a:hover,.side-menu a.active-link{background-color:var(--primary-color);padding-left:25px}.main-container{transition:margin-left .3s ease;padding:15px}.container{max-width:960px;margin:10px auto;background-color:var(--white-bg);padding:20px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.07)}h1{color:var(--text-dark);text-align:center;margin-bottom:20px;font-weight:700;font-size:1.8em;padding-top:55px}
        h2{color:var(--primary-color);margin:0 0 20px;font-weight:600;font-size:1.5em;border-bottom:2px solid var(--border-color);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center}#sync-indicator{font-size:.6em;font-weight:400;color:var(--text-light);opacity:0;transition:opacity .3s}#sync-indicator.visible{opacity:1}h3{color:var(--primary-color);margin-top:25px;margin-bottom:10px;font-size:1.4em}.content-panel{display:none}.content-panel.active{display:block;animation:fadeIn .5s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}label{display:block;margin-bottom:7px;font-weight:600;color:var(--text-light)}input[type=text],input[type=date],input[type=number],select,textarea{width:100%;padding:10px;margin-bottom:18px;border:1px solid #dcdcdc;border-radius:6px;box-sizing:border-box;font-size:1em}input:focus,select:focus,textarea:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 3px rgba(52,152,219,.2)}button{background-color:var(--secondary-color);color:#fff;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;font-size:1em;font-weight:600;width:100%;transition:background-color .3s ease,transform .2s ease;margin-top:8px}button:hover{background-color:#27ae60;transform:translateY(-1px)}button:disabled{background-color:#bdc3c7;cursor:not-allowed}button.cancel-btn{background-color:#95a5a6}.socios-list-container{margin-top:30px;border-top:2px solid var(--border-color)}.socio-card{padding:15px;background-color:#f7f9fc;border-radius:8px;margin-bottom:10px;border:1px solid #dbe9f5}.socio-card-info p{margin:4px 0;color:var(--text-light)}.socio-card-info p strong{color:var(--text-dark)}.socio-card-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;border-top:1px solid #e0e6ed;padding-top:10px}.socio-card-actions button{width:auto;font-size:.9em;padding:6px 10px}.socio-card-actions .edit-btn{background-color:var(--primary-color)}.socio-card-actions .delete-btn{background-color:var(--danger-color)}.socio-distribucion-card{background-color:#f7f9fc;border:1px solid #dbe9f5;border-radius:10px;padding:18px;box-shadow:0 4px 15px rgba(0,0,0,.06)}.anticipos-list-container{margin-top:15px;padding-top:10px;border-top:1px dashed var(--border-color)}.anticipos-list-container h4{margin:0 0 10px;font-size:1em;color:var(--text-dark)}.anticipo-item,.descuento-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:.9em;border-bottom:1px solid #eef2f6}.anticipo-item:last-child,.descuento-item:last-child{border-bottom:none}.anticipo-item-info,.descuento-item-info{display:flex;flex-direction:column;flex-grow:1}.anticipo-item-info span,.descuento-item-info span{color:var(--text-light)}.anticipo-item-info .monto,.descuento-item-info .monto{font-weight:600;color:var(--text-dark)}.descuento-item-info .categoria{font-size:0.85em;font-style:italic;color:var(--primary-color)}.anticipo-item-actions,.descuento-item-actions{display:flex;gap:5px}.anticipo-item-actions button,.descuento-item-actions button{font-size:.8em;padding:4px 8px;margin:0;width:auto}.anticipo-item-actions .edit-anticipo-btn,.descuento-item-actions .edit-descuento-btn{background-color:var(--warning-color)}.anticipo-item-actions .delete-anticipo-btn,.descuento-item-actions .delete-descuento-btn{background-color:var(--danger-color)}.general-total{background-color:var(--secondary-color);color:#fff;padding:12px 15px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:1.3em;font-weight:700}
        .action-button-group{display: grid;grid-template-columns: repeat(2, 1fr);gap: 10px;margin: 15px 0;}
        @media (min-width: 768px) { .action-button-group { grid-template-columns: repeat(3, 1fr); } #saveAllAnticiposAndDistribucionBtn { grid-column: span 2; } }
        @media (min-width: 992px) { .action-button-group { grid-template-columns: repeat(4, 1fr); } #saveAllAnticiposAndDistribucionBtn { grid-column: span 2; } }
        .show-punto-planta-btn{background-color:#9b59b6}#addAnticipoBtn{background-color:var(--primary-color)}.modal{display:none;position:fixed;z-index:2001;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center;animation:fadeInModal .3s}@keyframes fadeInModal{from{opacity:0}to{opacity:1}}.modal-content{background-color:#fefefe;padding:25px;border-radius:10px;width:90%;max-width:450px;text-align:center}.modal-content h3,.modal-content p,.modal-content label{text-align:left}.modal-content .modal-actions{display:flex;justify-content:space-around;margin-top:20px;gap: 10px}.modal-content .modal-actions button{flex:1}.close-button{position:absolute;top:10px;right:15px;color:#aaa;font-size:28px;font-weight:700;cursor:pointer}#balanceReport{padding:15px;border-radius:8px;background-color:#f8f9fa}#balanceReport p{margin:0;padding:8px 0;display:flex;justify-content:space-between;font-size:1.1em}#balanceReport p strong{color:var(--text-dark)}#balanceReport .balance-saldo.negative{color:var(--danger-color)}#balanceReport hr{border:0;border-top:1px solid var(--border-color);margin:8px 0}.anticipo-socio-info{background-color:#e6f7ff;border:1px solid #91d5ff;border-radius:8px;padding:15px;margin:20px 0}.anticipo-socio-info .saldo-disponible.negative span{color:var(--danger-color)}#toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:3000;display:flex;flex-direction:column;align-items:center;gap:10px}.toast{background-color:var(--text-dark);color:#fff;padding:12px 20px;border-radius:25px;box-shadow:0 4px 15px rgba(0,0,0,.1);font-size:.9em;font-weight:500;opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--secondary-color)}.toast.danger{background-color:var(--danger-color)}.toast.warning{background-color:var(--warning-color); color: #fff;}
        .part-time-actions{display:flex;flex-direction:column;gap:8px;margin-top:10px;border-top:1px solid var(--border-color);padding-top:10px}.part-time-actions button{width:100%;padding:8px;font-size:.85em}.part-time-actions .calendar-btn{background-color:#f39c12}.part-time-actions .calculate-btn{background-color:#1abc9c}.distribucion-part-time-container .puntos-calculados-pt{font-weight:700;color:#16a085}
        .socio-distribucion-card .individual-actions {display: flex;gap: 10px;margin-top: 15px;padding-top: 10px;border-top: 1px solid #e0e6ed;}
        .socio-distribucion-card .individual-actions button {flex: 1;padding: 8px 10px;font-size: 0.9em;margin-top: 0; }
        .socio-distribucion-card .upload-anticipos-btn {background-color: #f39c12; }
        .socio-distribucion-card .upload-anticipos-btn:hover {background-color: #e67e22; }
        .socio-distribucion-card .download-anticipos-btn {background-color: #3498db; }
        .socio-distribucion-card .download-anticipos-btn:hover {background-color: #2980b9; }
        #loadAllAnticiposBtn {background-color: #34495e;} #loadAllAnticiposBtn:hover {background-color: #2c3e50;}
        #uploadAllAnticiposBtn {background-color: #e67e22;} #uploadAllAnticiposBtn:hover {background-color: #d35400;}
        #saveAllAnticiposAndDistribucionBtn {background-color: #27ae60;} #saveAllAnticiposAndDistribucionBtn:hover {background-color: #1e8449;}
        #resetPuntoPlantaBtn {background-color: #c0392b;} #resetPuntoPlantaBtn:hover {background-color: #a93226;}
        #resetPartTimeDataBtn {background-color: #e74c3c; width: 100%; margin-bottom: 15px;} #resetPartTimeDataBtn:hover {background-color: #c0392b;}
        .side-menu a.arqueo-link {background-color: #e67e22;} .side-menu a.arqueo-link:hover {background-color: #d35400; padding-left: 25px;}
        .filtros-container{margin-bottom: 25px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--light-bg);}
        .filtros-container h3 {margin-top: 0; margin-bottom: 10px; border-bottom: none; color: var(--text-dark); font-size: 1.2em;}
        .filtros-grid {display: grid; grid-template-columns: 1fr; gap: 15px;}
        @media (min-width: 600px) { .filtros-grid { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 992px) { .filtros-grid { grid-template-columns: 1fr 1fr 1fr; } }
        .socio-card-info p.puntos-info {font-size: 0.9em;color: var(--text-dark);background-color: #eafaf1;padding: 5px 8px;border-radius: 4px;margin: 6px 0;border-left: 3px solid var(--secondary-color);}
        .socio-card-info p.puntos-info strong {font-weight: 700;}
        .socio-card-info p.fecha-ingreso-info {font-size: 0.9em;color: var(--primary-color);margin: 4px 0;}
        .distribucion-planta-container, .distribucion-part-time-container { display: block; margin-top: 15px; }
        .area-section-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; margin-bottom: 30px; }
        .area-header { background-color: #eef2f6; color: var(--text-dark); padding: 8px 15px; border-left: 4px solid var(--primary-color); border-radius: 4px; margin-bottom: 15px; font-size: 1.1em; font-weight: 700; }
        .calendar-discount-btn { background-color: #e67e22; width: 100%; margin-top: 8px; font-size: 0.85em; }
        .calendar-discount-btn:hover { background-color: #d35400; }
        .ausencias-info { color: #c0392b; font-weight: 600; font-size: 0.9em; margin-bottom: 5px; display: block;}
        .edit-saldo-anterior-btn {background: none; border: none; cursor: pointer; font-size: 1.1em; padding: 0 5px; color: var(--primary-color); width: auto; display: inline-block; margin: 0;}
        .saldo-anterior-row {display: flex; justify-content: space-between; align-items: center; background-color: #fff8e1; padding: 5px 8px; border-radius: 4px; margin: 5px 0; border: 1px solid #ffe082;}
        .socio-distribucion-card p { display: flex; justify-content: space-between; align-items: center; margin: 5px 0; }
        .propina-asignada { color: #2980b9; font-weight: 700; font-size: 1.05em; }
        .total-anticipos { color: #d35400; font-weight: 700; font-size: 1.05em; }
        .saldo-disponible { color: #27ae60; font-weight: 700; font-size: 1.2em; }
        .saldo-disponible.negative { color: #c0392b !important; }
        
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 2000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
        }
        .scroll-to-top.show { opacity: 1; visibility: visible; }
        .scroll-to-top:hover { transform: translateY(-5px); background-color: var(--primary-hover-color); }
        .scroll-to-top span { margin-top: -5px; }

        @media (min-width:992px){.menu-toggle{display:none}.side-menu{transform:translateX(0)}.main-container{margin-left:var(--menu-width)}.container h1{padding-top:0}}
    </style>
</head>
<body>
    <nav id="sideMenu" class="side-menu">
        <div class="menu-header">Men√∫</div>
        <a href="https://arqueo-teal.vercel.app/" class="menu-link arqueo-link" target="_blank">üí∞ Ir a Arqueo (Hoja de C√°lculo)</a>
        <a href="#" class="menu-link active-link" data-target="balanceContent">Balance General</a>
        <a href="#" class="menu-link" data-target="registroContent">Gestionar Socios</a>
        <a href="#" class="menu-link" data-target="distribucionContent">Distribuci√≥n de Propina</a>
    </nav>
    <div class="main-container" id="mainContainer">
        <button class="menu-toggle" id="menuToggle"><span></span><span></span><span></span></button>
        <div class="container">
            <h1>Gesti√≥n de Propina</h1>
            <div id="balanceContent" class="content-panel active">
                <h2><span>Balance General</span><span id="sync-indicator"></span></h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" id="syncDataBtn" style="background-color: #34495e; flex: 1;">üîÑ Sincronizar</button>
                    <button type="button" id="resetAnticiposLocalBtn" style="background-color: var(--danger-color); flex: 1;">üóëÔ∏è Limpiar Locales</button>
                </div>
                <div id="balanceReport">
                    <p><strong>Total Recaudado:</strong> <span id="balancePropinaBruta">$0</span></p>
                    <p><strong>(-) Descuentos:</strong> <span id="balanceDescuentos">$0</span></p>
                    <hr>
                    <p><strong>(=) Propina Neta:</strong> <span id="balancePropinaNeta">$0</span></p>
                    <p><strong>(-) Total Anticipos:</strong> <span id="balanceAnticipos">$0</span></p>
                    <hr>
                    <p><strong>Saldo Final:</strong> <span id="balanceSaldo" class="balance-saldo">$0</span></p>
                </div>
                <button type="button" id="addDescuentoBtn" style="background-color: var(--warning-color); margin-top: 20px;">Registrar Descuento</button>
                <div id="descuentosListContainer" style="margin-top: 20px;"></div>
                
                <div id="ultimaDistribucionReport" style="margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #ffeae8; border: 1px solid #d9534f; display: none;">
                    <h3>√öltima Distribuci√≥n</h3>
                    <p><strong>Fecha:</strong> <span id="ultimaDistFecha">N/A</span></p>
                    <p><strong>Neta:</strong> <span id="ultimaDistNeta">$0</span></p>
                    <p><strong>Punto Planta:</strong> <span id="ultimaDistPunto">$0</span></p>
                </div>
            </div>
            <div id="registroContent" class="content-panel">
                <h2>Gestionar Socios</h2>
                <button type="button" id="showRegisterSocioModalBtn" style="background-color: var(--primary-color); margin-bottom: 20px;">‚ûï Nuevo Socio</button>
                <div id="filtrosGestion" class="filtros-container">
                    <h3>Filtrar Socios</h3>
                    <div class="filtros-grid">
                        <div><label>Nombre:</label><input type="text" id="filtroNombreGestion" placeholder="Ej: Juan" style="margin-bottom:0;"></div>
                        <div><label>√Årea:</label><select id="filtroAreaGestion" style="margin-bottom:0;"><option value="todos">Todas</option><option value="Mesas">Mesas</option><option value="Maquinas">M√°quinas</option><option value="Boveda">Boveda</option></select></div>
                        <div><label>Contrato:</label><select id="filtroContratoGestion" style="margin-bottom:0;"><option value="todos">Todos</option><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select></div>
                    </div>
                </div>
                <div class="socios-list-container"><div id="sociosListContainer"></div></div>
            </div>
            <div id="distribucionContent" class="content-panel">
                <h2>Distribuci√≥n de Propina</h2>
                <div id="filtrosDistribucion" class="filtros-container">
                    <h3>Filtros</h3>
                    <div class="filtros-grid">
                        <div><label>Nombre:</label><input type="text" id="filtroNombre" placeholder="Ej: Juan" style="margin-bottom:0;"></div>
                        <div><label>√Årea:</label><select id="filtroArea" style="margin-bottom:0;"><option value="todos">Todas</option><option value="Mesas">Mesas</option><option value="Maquinas">M√°quinas</option><option value="Boveda">Boveda</option></select></div>
                        <div><label>Contrato:</label><select id="filtroContrato" style="margin-bottom:0;"><option value="todos">Todos</option><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select></div>
                    </div>
                </div>
                <div class="general-total" id="totalGeneralPropinaNetaDistribucion"></div>
                <div id="totalPuntosDisplay" style="text-align:center; font-weight:bold; background-color:#eafaf1; padding:10px; border-radius:8px; margin: 15px 0; border: 1px solid #c3e6cb;"></div>
                <div class="punto-planta-display-general" id="puntoPlantaDisplay"></div>
                <div class="action-button-group">
                    <button type="button" class="show-punto-planta-btn">Calcular Valor Punto</button>
                    <button type="button" id="resetPuntoPlantaBtn">üî¥ Reset Valor Punto</button>
                    <button type="button" id="addAnticipoBtn">Nuevo Anticipo</button>
                    <button type="button" id="loadAllAnticiposBtn">üì• Cargar de Sheets</button>
                    <button type="button" id="uploadAllAnticiposBtn" style="background-color: #f39c12;">‚¨ÜÔ∏è Subir a Sheets</button>
                    <button type="button" id="saveAllAnticiposAndDistribucionBtn" style="background-color: #27ae60;">üíæ Guardar Distribuci√≥n</button>
                </div>
                <button type="button" id="resetPartTimeDataBtn">üî¥ Reset PT y Ausencias</button>
                <div id="distribucionPlantaContainer"></div>
                <div id="distribucionPartTimeContainer"></div>
            </div>
        </div>
    </div>
    
    <!-- Bot√≥n Flotante Volver Arriba -->
    <button id="scrollToTopBtn" class="scroll-to-top" title="Volver arriba">
        <span>&#8679;</span>
    </button>
    
    <!-- Contenedor general para modales -->
    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <!-- Templates -->
    <template id="templateRegisterSocioModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Nuevo Socio</h3><form id="registroSocioFormModal">
            <label>Nombre:</label><input type="text" id="nombre" required>
            <label>Apellido:</label><input type="text" id="apellido" required>
            <label>Ingreso:</label><input type="date" id="fechaIngreso" required>
            <label>√Årea:</label>
            <select id="area" required>
                <option value="Mesas">Mesas</option>
                <option value="Maquinas">Maquinas</option>
                <option value="Boveda">Boveda</option>
            </select>
            <!-- Contenedor para Sub √Årea -->
            <div id="subAreaContainer" style="display:none; margin-top:5px; margin-bottom:15px; background-color:#f0f9ff; padding:8px; border-radius:5px;">
                <label style="color:#2980b9;">Sub-√Årea:</label>
                <select id="subArea">
                    <option value="">-- Ninguna --</option>
                    <option value="Cambistas">Cambistas</option>
                </select>
            </div>
            
            <label>Contrato:</label><select id="tipoContrato" required><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select>
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>
    
    <template id="templateAddAnticipoModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Anticipo</h3><form id="registroAnticipoForm">
            <label>Socio:</label><input list="sociosAnticipoList" id="anticipoSocioInput" type="text" required><datalist id="sociosAnticipoList"></datalist><input type="hidden" id="anticipoSocioId">
            <div id="anticipoSocioInfoContainer" class="anticipo-socio-info" style="display:none;">
                <p>Asignado: <span id="infoPropinaAsignada">$0</span></p>
                <p>Anticipos: <span id="infoAnticiposAnteriores">$0</span></p>
                <p class="saldo-disponible">Disp: <span id="infoSaldoDisponible">$0</span></p>
            </div>
            <label>Fecha:</label><input type="date" id="anticipoFecha" required>
            <label>Monto:</label><input type="text" id="anticipoCantidad" inputmode="numeric" required>
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>

    <template id="templatePuntoPlantaModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Valor Punto</h3>
            <p><strong>Neta:</strong> <span id="propinaNetaModal">$0</span></p>
            <p><strong>Total Puntos:</strong> <span id="totalPuntosGeneralDisplay" style="color:#28a745;">0</span></p><hr>
            <label>Divisor Manual:</label><input type="text" id="divisorManualInput" inputmode="decimal" placeholder="0.00">
            <p><strong>Valor:</strong> <strong id="valorPuntoCalculadoDisplay" style="color:var(--primary-color);">$0</strong></p>
            <button type="button" id="calcularPuntoPlantaInternoBtn">Guardar</button>
        </div></div>
    </template>
    
    <template id="templateAddDescuentoModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Descuento</h3><form id="registroDescuentoForm">
            <input type="hidden" id="descuentoId">
            <label>Categor√≠a:</label><select id="descuentoCategoria" required><option value="Caja Chica">Caja Chica</option><option value="Falla Operacional">Falla Operacional</option><option value="Gastos Materiales">Gastos Materiales</option><option value="Otro">Otro</option></select>
            <label>Descripci√≥n:</label><textarea id="descuentoDescripcion" rows="2" required></textarea>
            <label>Monto:</label><input type="text" id="descuentoCantidad" inputmode="numeric" required>
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>

    <template id="templateEditSocioModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Editar Socio</h3><form id="editSocioForm">
            <input type="hidden" id="editSocioId">
            <label>Nombre:</label><input type="text" id="editNombre" required>
            <label>Apellido:</label><input type="text" id="editApellido" required>
            <label>Ingreso:</label><input type="date" id="editFechaIngreso" required>
            <label>√Årea:</label>
            <select id="editArea" required>
                <option value="Mesas">Mesas</option>
                <option value="Maquinas">Maquinas</option>
                <option value="Boveda">Boveda</option>
            </select>
            
            <div id="editSubAreaContainer" style="display:none; margin-top:5px; margin-bottom:15px; background-color:#f0f9ff; padding:8px; border-radius:5px;">
                <label style="color:#2980b9;">Sub-√Årea:</label>
                <select id="editSubArea">
                    <option value="">-- Ninguna --</option>
                    <option value="Cambistas">Cambistas</option>
                </select>
            </div>
            
            <label>Contrato:</label><select id="editTipoContrato" required><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select>
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>
    
    <template id="templateEditAnticipoModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Editar Anticipo</h3><form id="editAnticipoForm">
            <input type="hidden" id="editSocioId"><input type="hidden" id="editAnticipoIndex">
            <label>Fecha:</label><input type="date" id="editAnticipoFecha" required>
            <label>Monto:</label><input type="text" id="editAnticipoCantidad" inputmode="numeric" required>
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>

    <template id="templateEditSaldoAnteriorModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Saldo Anterior</h3><form id="editSaldoAnteriorForm">
            <input type="hidden" id="editSaldoSocioId">
            <label>Monto:</label><input type="text" id="editSaldoMonto" inputmode="numeric" required placeholder="0">
            <button type="submit">Guardar</button>
        </form></div></div>
    </template>

    <template id="templateConfirmDeleteModal">
        <div class="modal"><div class="modal-content"><h3>Confirmar</h3><p id="confirmDeleteText"></p><div class="modal-actions"><button class="cancel-btn">Cancelar</button><button class="delete-btn confirm-delete-btn">Confirmar</button></div></div></div>
    </template>
    
    <template id="templateCalendarModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3 id="calendarModalTitle">D√≠as</h3>
            <input type="text" id="flatpickrInput" placeholder="Seleccionar...">
            <p style="text-align:center;">Seleccionados: <strong id="selectedDaysCount">0</strong></p>
            <p id="montoDescuentoInfo" style="text-align:center; display:none; font-weight:bold;"></p>
            <button id="saveCalendarBtn">Guardar</button>
        </div></div>
    </template>
    
    <template id="templatePartTimePointsModal">
        <div class="modal"><div class="modal-content"><span class="close-button">&times;</span><h3>Calcular Puntos</h3>
            <p>Puntos Base: <span id="partTimeModalBasePoints">0</span></p>
            <p>Asignable: <span id="partTimeModalAssignableAmount">$0</span></p><hr>
            <label>Divisor:</label><input type="text" id="partTimeMultiplicador" inputmode="decimal" required>
            <button type="button" id="calculatePartTimePointsInternoBtn">Calcular</button>
        </div></div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL_SOCIOS = 'https://script.google.com/macros/s/AKfycbyr447pMQtsKoBfp8qTcB1uyE3rORhgPPmZM6Fgia3BgmIvtlZ_h04uGZrmx_HwubHQ/exec'; 
            const SCRIPT_URL_RECAUDACIONES = 'https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec'; 

            const ui = {
                menuToggle: document.getElementById('menuToggle'), sideMenu: document.getElementById('sideMenu'), mainContainer: document.getElementById('mainContainer'), toastContainer: document.getElementById('toast-container'), modalContainer: document.getElementById('modal-container'), syncIndicator: document.getElementById('sync-indicator'),
                syncDataBtn: document.getElementById('syncDataBtn'), resetAnticiposLocalBtn: document.getElementById('resetAnticiposLocalBtn'), resetPuntoPlantaBtn: document.getElementById('resetPuntoPlantaBtn'), resetPartTimeDataBtn: document.getElementById('resetPartTimeDataBtn'),
                balancePropinaBruta: document.getElementById('balancePropinaBruta'), balanceDescuentos: document.getElementById('balanceDescuentos'), balancePropinaNeta: document.getElementById('balancePropinaNeta'), balanceAnticipos: document.getElementById('balanceAnticipos'), balanceSaldo: document.getElementById('balanceSaldo'),
                totalGeneralPropinaNetaDistribucion: document.getElementById('totalGeneralPropinaNetaDistribucion'), puntoPlantaDisplay: document.getElementById('puntoPlantaDisplay'), distribucionPlantaContainer: document.getElementById('distribucionPlantaContainer'), distribucionPartTimeContainer: document.getElementById('distribucionPartTimeContainer'),
                sociosListContainer: document.getElementById('sociosListContainer'), descuentosListContainer: document.getElementById('descuentosListContainer'), showRegisterSocioModalBtn: document.getElementById('showRegisterSocioModalBtn'),
                ultimaDistribucionReport: document.getElementById('ultimaDistribucionReport'), ultimaDistFecha: document.getElementById('ultimaDistFecha'), ultimaDistNeta: document.getElementById('ultimaDistNeta'), ultimaDistPunto: document.getElementById('ultimaDistPunto'),
                totalPuntosDisplay: document.getElementById('totalPuntosDisplay'), loadAllAnticiposBtn: document.getElementById('loadAllAnticiposBtn'), uploadAllAnticiposBtn: document.getElementById('uploadAllAnticiposBtn'), saveAllAnticiposAndDistribucionBtn: document.getElementById('saveAllAnticiposAndDistribucionBtn'),
                filtroNombre: document.getElementById('filtroNombre'), filtroArea: document.getElementById('filtroArea'), filtroContrato: document.getElementById('filtroContrato'), filtroNombreGestion: document.getElementById('filtroNombreGestion'), filtroAreaGestion: document.getElementById('filtroAreaGestion'), filtroContratoGestion: document.getElementById('filtroContratoGestion'),
                addAnticipoBtn: document.getElementById('addAnticipoBtn'), addDescuentoBtn: document.getElementById('addDescuentoBtn'),
                scrollToTopBtn: document.getElementById('scrollToTopBtn')
            };

            let isSyncing = false, sociosData = [], montosData = [], recaudacionPorDia = {}, ultimaDistribucionData = null, flatpickrInstance = null;
            
            // --- UTILIDADES ---
            const formatDisplayDate = (d) => { if(!d) return ''; const [y, m, day] = d.includes('T') ? d.split('T')[0].split('-') : d.split('-'); return `${day}-${m}-${y}`; };
            const normalizeRemoteDate = (s) => { if(!s) return ''; const str=String(s); return str.match(/^\d{4}-\d{2}-\d{2}/) ? str.substring(0,10) : (new Date(str).toISOString().split('T')[0]); };
            const showToast = (msg, t='success') => { const d=document.createElement('div'); d.className=`toast ${t}`; d.textContent=msg; ui.toastContainer.appendChild(d); setTimeout(()=>d.classList.add('show'),10); setTimeout(()=>{d.classList.remove('show');d.remove()},4000); };
            const formatNumber = (n) => new Intl.NumberFormat('es-CL').format(Math.round(n)||0);
            const parseNumber = (s) => parseFloat(String(s).replace(/\./g,'').replace(',','.'))||0;
            const parseMoney = (val) => { if (!val) return 0; if (typeof val === 'number') return val; const v = String(val).replace(/\./g, '').replace(',', '.'); return parseFloat(v) || 0; };
            const getStorage = (k) => JSON.parse(localStorage.getItem(k))||(k.includes('anticipos')?{}:k.includes('descuentos')?[]:{});
            const setStorage = (k,v) => localStorage.setItem(k,JSON.stringify(v));
            function setupNumericInputFormatting(el) { if(el) el.addEventListener('input', e=>{ let v=e.target.value.replace(/\./g,''); e.target.value=isNaN(v)||v.trim()===''?'':formatNumber(v); }); }

            // --- L√ìGICA SCROLL TOP ---
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    ui.scrollToTopBtn.classList.add('show');
                } else {
                    ui.scrollToTopBtn.classList.remove('show');
                }
            });
            ui.scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // --- GESTI√ìN DE MODALES ---
            function openModal(templateId, callback) {
                const template = document.getElementById(templateId);
                if (!template) return;
                const clone = template.content.cloneNode(true);
                const modal = clone.querySelector('.modal');
                ui.modalContainer.innerHTML = '';
                ui.modalContainer.appendChild(modal);
                modal.style.display = 'flex';
                
                const closeBtn = modal.querySelector('.close-button');
                const cancelBtn = modal.querySelector('.cancel-btn');
                const close = () => { modal.style.display = 'none'; ui.modalContainer.innerHTML = ''; };
                
                if (closeBtn) closeBtn.onclick = close;
                if (cancelBtn) cancelBtn.onclick = close;
                window.onclick = (e) => { if (e.target == modal) close(); };

                if (callback) {
                    const form = modal.querySelector('form');
                    callback(form || modal, modal);
                }
            }

            function confirmAction(message, onConfirm) {
                openModal('templateConfirmDeleteModal', (content, modal) => {
                    modal.querySelector('#confirmDeleteText').textContent = message;
                    modal.querySelector('.confirm-delete-btn').onclick = () => {
                        onConfirm();
                        modal.style.display = 'none';
                    };
                });
            }

            // --- L√ìGICA DE NEGOCIO ---
            function calcularPuntosLogica(fechaIngreso, area) {
                let anioIng = 0, mesIng = 0, diaIng = 0;
                if (!fechaIngreso) { const now = new Date(); anioIng = now.getFullYear(); mesIng = now.getMonth(); diaIng = now.getDate(); } 
                else {
                    const parts = String(fechaIngreso).split('-');
                    if (parts.length === 3) { anioIng = parseInt(parts[0], 10); mesIng = parseInt(parts[1], 10) - 1; diaIng = parseInt(parts[2], 10); } 
                    else { const d = new Date(fechaIngreso); if(isNaN(d.getTime())) { const now = new Date(); anioIng = now.getFullYear(); mesIng = now.getMonth(); diaIng = now.getDate(); } else { anioIng = d.getFullYear(); mesIng = d.getMonth(); diaIng = d.getDate(); } }
                }
                if (anioIng < 2000) { const now = new Date(); anioIng = now.getFullYear(); mesIng = now.getMonth(); diaIng = now.getDate(); }
                const hoy = new Date(); let anos = hoy.getFullYear() - anioIng; const mesActual = hoy.getMonth(); const diaActual = hoy.getDate();
                if (mesActual < mesIng || (mesActual === mesIng && diaActual < diaIng)) { anos--; }
                if (anos < 0) anos = 0;
                const puntosTeoricos = 4 + (anos * 2);
                
                let tope = 12; 
                const a = (area || '').toLowerCase();
                
                // Prioridad en Cambistas (sub-area de mesas o area sola)
                if (a.includes('cambista')) tope = 8;
                else if (a.includes('mesa')) tope = 20; 
                else if (a.includes('boveda') || a.includes('b√≥veda')) tope = 10; 
                else if (a.includes('maquina') || a.includes('m√°quina')) tope = 12;
                
                const puntosFinales = Math.min(puntosTeoricos, tope);
                return { puntos: puntosFinales, anos: anos, tope: tope, teoricos: puntosTeoricos };
            }

            const isPartTime = (s) => (s.TipoContrato||'').toLowerCase().trim()==='part-time';

            const recalculatePartTimeAssignable = (socioId) => {
                const pt = getStorage('part_time_data_v3');
                if(!pt[socioId]) return;
                let monto = 0;
                (pt[socioId].diasTrabajados || []).forEach(dia => {
                     monto += (recaudacionPorDia[dia] || 0);
                });
                pt[socioId].montoAsignable = monto;
                setStorage('part_time_data_v3', pt);
            };

            const updateAllUI = () => {
                const bruto = Object.values(recaudacionPorDia).reduce((a,b)=>a+b,0);
                const desc = getStorage('descuentos_operacionales_v1'), totalDesc = desc.reduce((s,d)=>s+d.cantidad,0), neta = bruto-totalDesc;
                const ants = getStorage('anticipos_data_v3'); let totalAnts = 0; Object.values(ants).forEach(l=>totalAnts+=l.reduce((s,a)=>s+a.cantidad,0));
                
                ui.balancePropinaBruta.textContent=`$${formatNumber(bruto)}`; 
                ui.balanceDescuentos.textContent=`$${formatNumber(totalDesc)}`;
                ui.balancePropinaNeta.textContent=`$${formatNumber(neta)}`; 
                ui.balanceAnticipos.textContent=`$${formatNumber(totalAnts)}`;
                ui.balanceSaldo.textContent=`$${formatNumber(neta-totalAnts)}`; ui.balanceSaldo.classList.toggle('negative', (neta-totalAnts)<0);
                ui.totalGeneralPropinaNetaDistribucion.textContent=`Propina a Distribuir: $${formatNumber(neta)}`;

                let pPlanta=0, pPT=0; 
                const ptData = getStorage('part_time_data_v3'), plantaAbs = getStorage('planta_absences_v1'), valPunto = parseFloat(localStorage.getItem('lastPuntoPlantaValue'))||0;

                sociosData.forEach(s => {
                    const calc = calcularPuntosLogica(s.FechaIngreso, s.Area);
                    s.infoCalculo = calc; 
                    if(isPartTime(s)) {
                        const d = ptData[s.ID]||{}; pPT += calc.puntos; s.propinaAsignada = calc.puntos * (d.puntosCalculados||0); s.puntosAsignadosFinales = calc.puntos;
                    } else {
                        let dineroPerdido = 0; (plantaAbs[s.ID]||[]).forEach(dia => dineroPerdido += (recaudacionPorDia[dia] || 0));
                        let factor = bruto > 0 ? (1 - (dineroPerdido / bruto)) : 1; if(factor<0)factor=0;
                        pPlanta += (calc.puntos * factor); s.propinaAsignada = (calc.puntos * factor) * valPunto; s.puntosAsignadosFinales = calc.puntos * factor; s.dineroDescontado = dineroPerdido;
                    }
                });

                ui.totalPuntosDisplay.innerHTML=`Total Puntos: <strong>${Math.round(pPlanta+pPT)}</strong> (Planta: ${Math.round(pPlanta)} + PT: ${Math.round(pPT)})`;
                ui.puntoPlantaDisplay.innerHTML = valPunto>0 ? `<p style="text-align:center;font-weight:bold;background:#f0f9ff;padding:10px;">Valor Punto: $${formatNumber(valPunto)}</p>` : '';
                renderSociosFiltrados(); renderDescuentos(desc);
                if(ultimaDistribucionData?.resumen) {
                    ui.ultimaDistFecha.textContent=ultimaDistribucionData.resumen.fecha; ui.ultimaDistNeta.textContent=`$${formatNumber(ultimaDistribucionData.resumen.propinaNeta)}`; ui.ultimaDistPunto.textContent=`$${formatNumber(ultimaDistribucionData.resumen.puntoPlanta)}`; ui.ultimaDistribucionReport.style.display='block';
                } else ui.ultimaDistribucionReport.style.display='none';
            };

            const renderDescuentos = (list) => {
                ui.descuentosListContainer.innerHTML = list.length ? list.map(d =>
                    `<div class="descuento-item"><div class="descuento-item-info"><span class="monto">$${formatNumber(d.cantidad)} - ${d.descripcion}</span><span class="categoria">${d.categoria}</span></div><div class="descuento-item-actions"><button class="edit-descuento-btn" data-id="${d.id}">‚úèÔ∏è</button><button class="delete-descuento-btn" data-id="${d.id}">üóëÔ∏è</button></div></div>`
                ).join('') : '<p>Sin descuentos.</p>';
            };

            const renderSociosFiltrados = () => {
                const fN=ui.filtroNombre.value.toLowerCase(), fA=ui.filtroArea.value, fC=ui.filtroContrato.value;
                const fNG=ui.filtroNombreGestion.value.toLowerCase(), fAG=ui.filtroAreaGestion.value, fCG=ui.filtroContratoGestion.value;
                const filterFn = (s, n, a, c) => `${s.Nombre} ${s.Apellido}`.toLowerCase().includes(n) && (a==='todos'||s.Area===a) && (c==='todos'||s.TipoContrato===c);
                renderSocios(sociosData.filter(s=>filterFn(s,fNG,fAG,fCG)), sociosData.filter(s=>filterFn(s,fN,fA,fC)));
            };

            const renderSocios = (gest, dist) => {
                ui.sociosListContainer.innerHTML = gest.length ? '' : '<p>Sin socios.</p>';
                if(gest.length) {
                    const grp = gest.reduce((a,s)=>{ (a[s.Area]=a[s.Area]||[]).push(s); return a;},{});
                    // Orden din√°mico para incluir sub-√°reas creadas
                    const areasOrdenadas = Object.keys(grp).sort();
                    
                    areasOrdenadas.forEach(area => {
                        const div=document.createElement('div'); div.innerHTML=`<h3 style="margin-top:30px; border-bottom:1px solid #ddd">${area}</h3>`;
                        grp[area].forEach(s=>div.appendChild(createCard(s, 'manage')));
                        ui.sociosListContainer.appendChild(div);
                    });
                }
                
                ui.distribucionPlantaContainer.innerHTML='<h3>Planta</h3>'; ui.distribucionPartTimeContainer.innerHTML='<h3>Part-Time</h3>';
                const renderArea = (list, cont) => {
                    if(!list.length) { cont.innerHTML+='<p style="color:#777;">Sin socios.</p>'; return; }
                    const grp = list.reduce((a,s)=>{ (a[s.Area]=a[s.Area]||[]).push(s); return a;},{});
                    
                    // Orden din√°mico aqu√≠ tambi√©n
                    Object.keys(grp).sort().forEach(area => {
                        const totalAreaPts = grp[area].reduce((acc, s) => acc + (s.puntosAsignadosFinales || 0), 0);
                        cont.innerHTML+=`<div class="area-header">${area} <span style="float:right">Puntos: ${Math.round(totalAreaPts)}</span></div>`;
                        const grid = document.createElement('div'); grid.className='area-section-grid';
                        grp[area].forEach(s=>grid.appendChild(createCard(s, 'dist')));
                        cont.appendChild(grid);
                    });
                };
                renderArea(dist.filter(s=>!isPartTime(s)), ui.distribucionPlantaContainer);
                renderArea(dist.filter(isPartTime), ui.distribucionPartTimeContainer);
                updatePropinaUI();
            };

            const createCard = (s, type) => {
                const card = document.createElement('div'); const info = s.infoCalculo;
                if(type==='manage') {
                    card.className='socio-card';
                    const ptData = getStorage('part_time_data_v3')[s.ID]||{};
                    const extra = isPartTime(s) ? `<p>D√≠as: ${(ptData.diasTrabajados||[]).length}</p><div class="part-time-actions"><button class="calendar-btn" data-socio-id="${s.ID}">D√≠as</button><button class="calculate-btn" data-socio-id="${s.ID}">Calc. Puntos</button></div>` : '';
                    card.innerHTML = `<div class="socio-card-info"><p><strong>${s.Nombre} ${s.Apellido}</strong></p><p>${s.Area} - ${s.TipoContrato}</p><p class="puntos-info">Puntos: <strong>${info.puntos}</strong> (${info.anos} a√±os)</p><p class="fecha-ingreso-info">Ingreso: ${formatDisplayDate(s.FechaIngreso)}</p>${extra}</div><div class="socio-card-actions"><button class="edit-btn" data-socio-id="${s.ID}">‚úèÔ∏è</button><button class="delete-btn" data-socio-id="${s.ID}">üóëÔ∏è</button></div>`;
                } else {
                    card.className='socio-distribucion-card'; card.dataset.socioId=s.ID;
                    let ptsDisplay = `Puntos: ${info.puntos}`;
                    let actionBtn = '';
                    if(!isPartTime(s)) {
                        const aus = (getStorage('planta_absences_v1')[s.ID]||[]).length;
                        if(aus > 0) ptsDisplay += ` <span class="ausencias-info">(-${aus} d√≠as / -$${formatNumber(s.dineroDescontado)})</span>`;
                        actionBtn = `<button class="calendar-discount-btn" data-socio-id="${s.ID}">üìÖ Ausencias</button>`;
                    }
                    card.innerHTML = `<h3>${s.Nombre} ${s.Apellido}</h3><p>${ptsDisplay}</p><p>Asignado: <span class="propina-asignada">$0</span></p><div class="saldo-anterior-row"><span>Saldo Ant: <strong>$${formatNumber(getStorage('saldo_anterior_v1')[s.ID]||0)}</strong></span><button class="edit-saldo-anterior-btn" data-socio-id="${s.ID}">üí∞</button></div><p>Anticipos: <span class="total-anticipos">$0</span></p><p>Saldo Final: <span class="saldo-disponible">$0</span></p>${actionBtn}<div class="anticipos-container"></div><div class="individual-actions"><button class="download-anticipos-btn" data-socio-id="${s.ID}">üì•</button><button class="upload-anticipos-btn" data-socio-id="${s.ID}">‚¨ÜÔ∏è</button></div>`;
                }
                return card;
            };

            const updatePropinaUI = () => {
                const ants = getStorage('anticipos_data_v3'), saldoAntData = getStorage('saldo_anterior_v1');
                sociosData.forEach(s => {
                    const c = document.querySelector(`.socio-distribucion-card[data-socio-id="${s.ID}"]`); if(!c) return;
                    const antS = ants[s.ID]||[], totA = antS.reduce((a,b)=>a+b.cantidad,0), sal = s.propinaAsignada - totA + (saldoAntData[s.ID]||0);
                    c.querySelector('.propina-asignada').textContent=`$${formatNumber(s.propinaAsignada)}`;
                    c.querySelector('.total-anticipos').textContent=`$${formatNumber(totA)}`;
                    const elSal = c.querySelector('.saldo-disponible'); elSal.textContent=`$${formatNumber(sal)}`; elSal.classList.toggle('negative', sal<0);
                    c.querySelector('.anticipos-container').innerHTML = antS.length ? `<div class="anticipos-list-container"><h4>Anticipos</h4>${antS.map((a,i)=>`<div class="anticipo-item"><span class="monto">$${formatNumber(a.cantidad)} (${formatDisplayDate(a.fecha)})</span><div class="anticipo-item-actions"><button class="edit-anticipo-btn" data-socio-id="${s.ID}" data-anticipo-index="${i}">‚úèÔ∏è</button><button class="delete-anticipo-btn" data-socio-id="${s.ID}" data-anticipo-index="${i}">üóëÔ∏è</button></div></div>`).join('')}</div>` : '';
                });
            };

            async function apiCall(url, action, method='GET', body=null) {
                const opt = { method, mode:'cors' }; if(method!=='GET') opt.body=JSON.stringify({action, ...body});
                const r = await fetch(method==='GET'?`${url}?action=${action}`:url, opt); const res = await r.json(); 
                if(res.status!=='success') throw new Error(res.message); return res.data||res;
            }

            async function syncData() { 
                if(isSyncing)return; isSyncing=true; ui.syncIndicator.classList.add('visible'); ui.balancePropinaBruta.innerHTML='<span style="color:#f39c12;">...</span>';
                try{ 
                    const urlRec = SCRIPT_URL_RECAUDACIONES + (SCRIPT_URL_RECAUDACIONES.includes('?') ? '&' : '?') + 'action=get&t=' + new Date().getTime();
                    const recRes = await fetch(urlRec); const recJson = await recRes.json();
                    let listaRec = [];
                    if (Array.isArray(recJson)) listaRec = recJson;
                    else if (recJson.data && Array.isArray(recJson.data)) listaRec = recJson.data;
                    else if (recJson.result && Array.isArray(recJson.result)) listaRec = recJson.result;
                    
                    montosData = listaRec; 
                    recaudacionPorDia={}; 
                    if(Array.isArray(montosData)) {
                        montosData.forEach(r=>{ 
                            if(r.fecha && r.monto) {
                                let m = parseMoney(r.monto);
                                let fRec = normalizeRemoteDate(r.fecha);
                                recaudacionPorDia[fRec]=(recaudacionPorDia[fRec]||0)+m; 
                            }
                        });
                    }

                    const rS = await apiCall(SCRIPT_URL_SOCIOS,'getSocios'); 
                    sociosData=rS.map(s=>({...s, propinaAsignada:0})); 
                    
                    const pt=getStorage('part_time_data_v3'); 
                    sociosData.filter(isPartTime).forEach(s=>{ 
                        if(!pt[s.ID]) pt[s.ID]={diasTrabajados:[],montoAsignable:0}; 
                        let m=0; (pt[s.ID].diasTrabajados||[]).forEach(d=>{ m+=(recaudacionPorDia[d]||0); }); 
                        pt[s.ID].montoAsignable=m; 
                    }); 
                    setStorage('part_time_data_v3',pt);
                    
                    try{ultimaDistribucionData=await apiCall(SCRIPT_URL_SOCIOS,'getUltimaDistribucion');}catch(e){} 
                    updateAllUI(); showToast('Sincronizado'); 
                }catch(e){ ui.balancePropinaBruta.textContent="Error"; console.error(e); showToast("Error Sincronizando", 'danger'); } finally{isSyncing=false;ui.syncIndicator.classList.remove('visible');} 
            }

            // --- MANEJADORES DE ACCI√ìN ---
            function setupAreaSelects(form, mainId, subId, subContainerId) {
                const mainSelect = form.querySelector(`#${mainId}`);
                const subSelect = form.querySelector(`#${subId}`);
                const subContainer = form.querySelector(`#${subContainerId}`);

                const toggle = () => {
                    if (mainSelect.value === 'Mesas') {
                        subContainer.style.display = 'block';
                    } else {
                        subContainer.style.display = 'none';
                        subSelect.value = '';
                    }
                };

                mainSelect.addEventListener('change', toggle);
                // Inicializar estado
                toggle();
            }

            function handleShowEditSocioModal(socioId) {
                const socio = sociosData.find(s => s.ID == socioId);
                if (!socio) return;
                openModal('templateEditSocioModal', (form) => {
                    // Configurar l√≥gica de sub-√°reas
                    setupAreaSelects(form, 'editArea', 'editSubArea', 'editSubAreaContainer');

                    form.editSocioId.value = socio.ID;
                    form.editNombre.value = socio.Nombre;
                    form.editApellido.value = socio.Apellido;
                    form.editFechaIngreso.value = normalizeRemoteDate(socio.FechaIngreso);
                    
                    // Parsear √Årea para separar Sub-√Årea si existe
                    if (socio.Area.includes(' - Cambistas')) {
                        form.editArea.value = 'Mesas';
                        // Disparar evento change manualmente para mostrar el contenedor
                        form.editArea.dispatchEvent(new Event('change'));
                        form.editSubArea.value = 'Cambistas';
                    } else {
                        form.editArea.value = socio.Area;
                        form.editArea.dispatchEvent(new Event('change'));
                    }

                    form.editTipoContrato.value = socio.TipoContrato;
                    
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        let finalArea = form.editArea.value;
                        if (finalArea === 'Mesas' && form.editSubArea.value) {
                            finalArea += ' - ' + form.editSubArea.value;
                        }

                        try {
                            await apiCall(SCRIPT_URL_SOCIOS, 'updateSocio', 'POST', {
                                socioId: socio.ID,
                                updates: {
                                    Nombre: form.editNombre.value,
                                    Apellido: form.editApellido.value,
                                    FechaIngreso: form.editFechaIngreso.value,
                                    Area: finalArea,
                                    TipoContrato: form.editTipoContrato.value
                                }
                            });
                            showToast('Socio actualizado');
                            document.querySelector('.modal').style.display = 'none';
                            syncData();
                        } catch (error) {
                            showToast(error.message, 'danger');
                        }
                    };
                });
            }

            function handleEditAnt(socioId, index) {
                const ants = getStorage('anticipos_data_v3');
                const anticipo = ants[socioId][index];
                if (!anticipo) return;
                openModal('templateEditAnticipoModal', (form) => {
                    setupNumericInputFormatting(form.editAnticipoCantidad);
                    form.editSocioId.value = socioId;
                    form.editAnticipoIndex.value = index;
                    form.editAnticipoFecha.value = normalizeRemoteDate(anticipo.fecha);
                    form.editAnticipoCantidad.value = formatNumber(anticipo.cantidad);
                    
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        ants[socioId][index] = {
                            fecha: form.editAnticipoFecha.value,
                            cantidad: parseNumber(form.editAnticipoCantidad.value)
                        };
                        setStorage('anticipos_data_v3', ants);
                        updateAllUI();
                        document.querySelector('.modal').style.display = 'none';
                        showToast('Anticipo editado');
                    };
                });
            }

            function handleShowDescuentoModal(id = null) {
                const descuentos = getStorage('descuentos_operacionales_v1');
                const descuento = id ? descuentos.find(d => d.id == id) : null;
                
                openModal('templateAddDescuentoModal', (form) => {
                    setupNumericInputFormatting(form.descuentoCantidad);
                    if (descuento) {
                        form.descuentoId.value = descuento.id;
                        form.descuentoCategoria.value = descuento.categoria;
                        form.descuentoDescripcion.value = descuento.descripcion;
                        form.descuentoCantidad.value = formatNumber(descuento.cantidad);
                    }
                    
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const nuevoDescuento = {
                            id: descuento ? descuento.id : Date.now().toString(),
                            categoria: form.descuentoCategoria.value,
                            descripcion: form.descuentoDescripcion.value,
                            cantidad: parseNumber(form.descuentoCantidad.value)
                        };
                        
                        let newList;
                        if (descuento) {
                            newList = descuentos.map(d => d.id == descuento.id ? nuevoDescuento : d);
                        } else {
                            newList = [...descuentos, nuevoDescuento];
                        }
                        
                        setStorage('descuentos_operacionales_v1', newList);
                        updateAllUI();
                        document.querySelector('.modal').style.display = 'none';
                        showToast('Descuento guardado');
                    };
                });
            }

            function handleDownloadAnticipos(socioId) {
                const socio = sociosData.find(s => s.ID == socioId);
                const ants = getStorage('anticipos_data_v3')[socioId] || [];
                if (!ants.length) { showToast('Sin anticipos', 'warning'); return; }
                
                let text = `Anticipos: ${socio.Nombre} ${socio.Apellido}\n\n`;
                ants.forEach(a => {
                    text += `${formatDisplayDate(a.fecha)}: $${formatNumber(a.cantidad)}\n`;
                });
                text += `\nTotal: $${formatNumber(ants.reduce((s, a) => s + a.cantidad, 0))}`;
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Anticipos_${socio.Nombre.replace(/\s+/g,'_')}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            async function handleSaveDistribucionFinal(){
                const neta=parseNumber(ui.balancePropinaNeta.textContent);
                const punto=parseFloat(localStorage.getItem('lastPuntoPlantaValue'))||0;
                
                if(punto<=0){showToast('Falta calcular punto planta','warning');return;}
                
                const ants=getStorage('anticipos_data_v3');
                const saldoAnt=getStorage('saldo_anterior_v1');
                const detalleAnts=[];
                
                const distribucion=sociosData.map(s=>{
                    const l=ants[s.ID]||[];
                    const sumA=l.reduce((x,y)=>x+y.cantidad,0);
                    l.forEach(a=>detalleAnts.push({id:s.ID,nombre:`${s.Nombre} ${s.Apellido}`,fecha:a.fecha,monto:Math.round(a.cantidad)}));
                    return{
                        ID:s.ID,
                        NombreCompleto:`${s.Nombre} ${s.Apellido}`,
                        Area:s.Area,
                        TipoContrato:s.TipoContrato,
                        PuntosAntiguedad:s.infoCalculo.puntos,
                        PuntosFinales:s.puntosAsignadosFinales,
                        PropinaAsignada:Math.round(s.propinaAsignada),
                        Anticipos:Math.round(sumA),
                        SaldoFinal:Math.round(s.propinaAsignada-sumA+(saldoAnt[s.ID]||0))
                    };
                });

                try{
                    showToast('Guardando en la nube...', 'warning');
                    const res=await apiCall(SCRIPT_URL_SOCIOS,'guardarDistribucion','POST',{
                        resumen:{
                            fecha:new Date().toISOString().split('T')[0],
                            propinaNeta:neta,
                            puntoPlanta:punto,
                            totalPuntos:parseFloat((ui.totalPuntosDisplay.innerText.match(/[\d\.]+/)||['0'])[0]),
                            totalAnticipos:detalleAnts.reduce((a,b)=>a+b.monto,0)
                        },
                        distribucion,
                        descuentos:getStorage('descuentos_operacionales_v1'),
                        detalleAnticipos:detalleAnts
                    });
                    showToast(`Guardado. Hoja: ${res.sheetName}`);
                    localStorage.removeItem('anticipos_data_v3');
                    syncData();
                }catch(e){
                    showToast(e.message,'danger');
                }
            }

            async function handleUploadAllAnticipos(){
                const all=getStorage('anticipos_data_v3'),list=[];
                Object.keys(all).forEach(id=>{
                    const s=sociosData.find(x=>x.ID===id);
                    if(s)all[id].forEach(a=>list.push({id,nombre:`${s.Nombre} ${s.Apellido}`,fecha:a.fecha,monto:Math.round(a.cantidad)}));
                });
                if(!list.length){showToast('Nada que subir','warning');return;}
                try{showToast('Subiendo...');await apiCall(SCRIPT_URL_SOCIOS,'registrarTodosLosAnticipos','POST',{detalleAnticipos:list});showToast('√âxito');}catch(e){showToast(e.message,'danger');}
            }
            
            function handleEditSaldoAnterior(id){
                openModal('templateEditSaldoAnteriorModal',f=>{
                    setupNumericInputFormatting(f.editSaldoMonto);
                    f.editSaldoMonto.value=formatNumber(getStorage('saldo_anterior_v1')[id]||0);
                    f.editSaldoSocioId.value=id;
                    f.onsubmit=e=>{
                        e.preventDefault();
                        const l=getStorage('saldo_anterior_v1');
                        l[id]=parseNumber(f.editSaldoMonto.value);
                        setStorage('saldo_anterior_v1',l);
                        updateAllUI();
                        document.querySelector('.modal').style.display='none';
                    }
                });
            }

            function openPuntoPlanta(){
                openModal('templatePuntoPlantaModal',(div,m)=>{
                    const bruto=Object.values(recaudacionPorDia).reduce((a,b)=>a+b,0);
                    const neta=bruto-getStorage('descuentos_operacionales_v1').reduce((s,d)=>s+d.cantidad,0);
                    m.querySelector('#propinaNetaModal').textContent=`$${formatNumber(neta)}`;
                    let tp=0;
                    const abs=getStorage('planta_absences_v1');
                    sociosData.forEach(s=>{
                        if(isPartTime(s)){tp+=s.infoCalculo.puntos;}
                        else{
                            let dp=0;(abs[s.ID]||[]).forEach(d=>dp+=(recaudacionPorDia[d]||0));
                            let f=bruto>0?(1-(dp/bruto)):1; if(f<0)f=0;
                            tp+=(s.infoCalculo.puntos*f);
                        }
                    });
                    m.querySelector('#totalPuntosGeneralDisplay').textContent=Math.round(tp);
                    const inp=m.querySelector('#divisorManualInput');
                    inp.value=Math.round(tp);
                    const cal=()=>{const v=neta/parseNumber(inp.value);m.querySelector('#valorPuntoCalculadoDisplay').textContent=v>0?`$${formatNumber(v)}`:'$0';};
                    inp.oninput=cal; cal();
                    m.querySelector('#calcularPuntoPlantaInternoBtn').onclick=()=>{
                        localStorage.setItem('lastPuntoPlantaValue',neta/parseNumber(inp.value));
                        updateAllUI();m.style.display='none';
                    };
                });
            }

            function abrirCalendarModal(id,mode){
                const s=sociosData.find(x=>x.ID===id);
                openModal('templateCalendarModal',(d,m)=>{
                    m.querySelector('#calendarModalTitle').textContent=mode==='PT'?'D√≠as PT':'Ausencias';
                    const info=m.querySelector('#montoDescuentoInfo');
                    let dias=mode==='PT'?(getStorage('part_time_data_v3')[id]||{}).diasTrabajados||[]:getStorage('planta_absences_v1')[id]||[];
                    m.querySelector('#selectedDaysCount').textContent=dias.length;
                    const upd=(sel)=>{
                        let t=0; sel.forEach(d=>t+=(recaudacionPorDia[flatpickrInstance.formatDate(d,"Y-m-d")]||0));
                        info.style.display='block';
                        info.style.color=mode==='PT'?'#27ae60':'#c0392b';
                        info.textContent=`Total: $${formatNumber(t)}`;
                        m.querySelector('#selectedDaysCount').textContent=sel.length;
                    };
                    flatpickrInstance=flatpickr(m.querySelector('#flatpickrInput'),{
                        mode:"multiple",dateFormat:"Y-m-d",defaultDate:dias,locale:"es",
                        onChange:upd,onOpen:()=>upd(flatpickrInstance.selectedDates)
                    });
                    m.querySelector('#saveCalendarBtn').onclick=()=>{
                        const sel=flatpickrInstance.selectedDates.map(d=>flatpickrInstance.formatDate(d,"Y-m-d"));
                        if(mode==='PT'){
                            const pt=getStorage('part_time_data_v3');
                            pt[id]={...(pt[id]||{}),diasTrabajados:sel};
                            setStorage('part_time_data_v3',pt);
                            recalculatePartTimeAssignable(s.ID);
                        }else{
                            const abs=getStorage('planta_absences_v1');
                            abs[id]=sel;
                            setStorage('planta_absences_v1',abs);
                        }
                        updateAllUI();showToast('Guardado');m.style.display='none';
                    };
                });
            }

            function abrirPuntosPT(id){
                openModal('templatePartTimePointsModal',(f,m)=>{
                    const pt=getStorage('part_time_data_v3')[id]||{};
                    m.querySelector('#partTimeModalBasePoints').textContent=sociosData.find(x=>x.ID===id).infoCalculo.puntos;
                    m.querySelector('#partTimeModalAssignableAmount').textContent=`$${formatNumber(pt.montoAsignable||0)}`;
                    m.querySelector('#calculatePartTimePointsInternoBtn').onclick=()=>{
                        const d=parseNumber(m.querySelector('#partTimeMultiplicador').value);
                        if(d>0){
                            pt.puntosCalculados=(pt.montoAsignable||0)/d;
                            const st=getStorage('part_time_data_v3');
                            st[id]=pt;
                            setStorage('part_time_data_v3',st);
                            updateAllUI();m.style.display='none';
                        }
                    };
                });
            }

            // --- LISTENERS GENERALES ---
            ui.menuToggle.onclick=e=>{e.stopPropagation();ui.sideMenu.classList.toggle('open'); ui.menuToggle.classList.toggle('active');};
            document.addEventListener('click', e=>{ 
                if(ui.sideMenu.classList.contains('open') && !ui.sideMenu.contains(e.target) && !ui.menuToggle.contains(e.target)) { ui.sideMenu.classList.remove('open'); ui.menuToggle.classList.remove('active'); }
                const edit=e.target.closest('.edit-btn'); if(edit) handleShowEditSocioModal(edit.dataset.socioId);
                const del=e.target.closest('.delete-btn'); if(del) confirmAction('¬øEliminar Socio permanentemente?',async()=>{ await apiCall(SCRIPT_URL_SOCIOS,'deleteSocio','POST',{socioId:del.dataset.socioId}); syncData(); });
                const cal=e.target.closest('.calendar-btn'); if(cal) abrirCalendarModal(cal.dataset.socioId, 'PT');
                const calP=e.target.closest('.calendar-discount-btn'); if(calP) abrirCalendarModal(calP.dataset.socioId, 'PLANTA');
                const cpt=e.target.closest('.calculate-btn'); if(cpt) abrirPuntosPT(cpt.dataset.socioId);
                const edA=e.target.closest('.edit-anticipo-btn'); if(edA) handleEditAnt(edA.dataset.socioId, edA.dataset.anticipoIndex);
                const dlA=e.target.closest('.delete-anticipo-btn'); if(dlA) confirmAction('¬øBorrar anticipo?',()=>{ const l=getStorage('anticipos_data_v3'); l[dlA.dataset.socioId].splice(dlA.dataset.anticipoIndex,1); setStorage('anticipos_data_v3',l); updateAllUI(); });
                const edD=e.target.closest('.edit-descuento-btn'); if(edD) handleShowDescuentoModal(edD.dataset.id);
                const dlD=e.target.closest('.delete-descuento-btn'); if(dlD) confirmAction('¬øBorrar descuento?',()=>{ const l=getStorage('descuentos_operacionales_v1').filter(x=>x.id!=dlD.dataset.id); setStorage('descuentos_operacionales_v1',l); updateAllUI(); });
                const up=e.target.closest('.upload-anticipos-btn'); if(up) handleUploadAllAnticipos();
                const down=e.target.closest('.download-anticipos-btn'); if(down) handleDownloadAnticipos(down.dataset.socioId);
                const esal=e.target.closest('.edit-saldo-anterior-btn'); if(esal) handleEditSaldoAnterior(esal.dataset.socioId);
            });

            document.querySelectorAll('.menu-link').forEach(l=>l.onclick=e=>{if(l.target!=='_blank'){e.preventDefault();document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));document.getElementById(l.dataset.target).classList.add('active');if(window.innerWidth<=991){ui.sideMenu.classList.remove('open');ui.menuToggle.classList.remove('active');}}});
            [ui.filtroNombre,ui.filtroArea,ui.filtroContrato,ui.filtroNombreGestion,ui.filtroAreaGestion,ui.filtroContratoGestion].forEach(el=>el.addEventListener('input',renderSociosFiltrados));
            
            // --- BOTONES PRINCIPALES ---
            ui.syncDataBtn.onclick=syncData;
            
            ui.resetAnticiposLocalBtn.onclick = () => confirmAction('¬øBorrar TODOS los anticipos locales? Esto no se puede deshacer.', () => {
                localStorage.removeItem('anticipos_data_v3');
                updateAllUI();
                showToast('Anticipos locales borrados');
            });

            ui.resetPuntoPlantaBtn.onclick = () => confirmAction('¬øResetear valor punto planta?', () => {
                localStorage.removeItem('lastPuntoPlantaValue');
                updateAllUI();
                showToast('Punto planta reseteado');
            });

            ui.resetPartTimeDataBtn.onclick = () => confirmAction('¬øBorrar c√°lculos Part-Time y Ausencias?', () => {
                localStorage.removeItem('part_time_data_v3');
                localStorage.removeItem('planta_absences_v1');
                updateAllUI();
                showToast('Datos de tiempo reiniciados');
            });

            ui.saveAllAnticiposAndDistribucionBtn.onclick = () => confirmAction('¬øDesea cerrar la distribuci√≥n y guardar en Google Sheets?', handleSaveDistribucionFinal);

            // Registro de Socio: Manejo de Sub-√Årea
            ui.showRegisterSocioModalBtn.onclick=()=>openModal('templateRegisterSocioModal',f=>{
                setupAreaSelects(f, 'area', 'subArea', 'subAreaContainer');

                f.onsubmit=async e=>{
                    e.preventDefault();
                    let finalArea = f.area.value;
                    if (finalArea === 'Mesas' && f.subArea.value) {
                        finalArea += ' - ' + f.subArea.value;
                    }
                    try{
                        await apiCall(SCRIPT_URL_SOCIOS,'addSocio','POST',{
                            socio:{
                                Nombre:f.nombre.value, 
                                Apellido:f.apellido.value, 
                                FechaIngreso:f.fechaIngreso.value, 
                                Area:finalArea, 
                                TipoContrato:f.tipoContrato.value
                            }
                        });
                        showToast('Guardado');
                        document.querySelector('.modal').style.display='none';
                        syncData();
                    }catch(e){
                        showToast(e.message,'danger');
                    }
                }
            });
            
            ui.addAnticipoBtn.onclick=()=>openModal('templateAddAnticipoModal',(f,m)=>{m.querySelector('#sociosAnticipoList').innerHTML=sociosData.map(s=>`<option value="${s.Nombre} ${s.Apellido}" data-id="${s.ID}">`).join(''); m.querySelector('#anticipoSocioInput').oninput=e=>{const o=[...m.querySelectorAll('option')].find(x=>x.value===e.target.value); if(o) m.querySelector('#anticipoSocioId').value=o.dataset.id;}; setupNumericInputFormatting(f.anticipoCantidad); f.onsubmit=e=>{e.preventDefault();const id=e.target.anticipoSocioId.value;if(id){const l=getStorage('anticipos_data_v3');if(!l[id])l[id]=[];l[id].push({fecha:f.anticipoFecha.value,cantidad:parseNumber(f.anticipoCantidad.value)});setStorage('anticipos_data_v3',l);updateAllUI();m.style.display='none';}}});
            
            ui.addDescuentoBtn.onclick=()=>handleShowDescuentoModal();
            document.querySelector('.show-punto-planta-btn').onclick=openPuntoPlanta;
            
            ui.loadAllAnticiposBtn.onclick=async()=>{try{showToast('Cargando...');const d=await apiCall(SCRIPT_URL_SOCIOS,'getAllAnticiposDesdeSheets','POST');if(!Object.keys(d).length){showToast('Nada pendiente');return;}const l=getStorage('anticipos_data_v3');for(const id in d){if(!l[id])l[id]=[];const ex=new Set(l[id].map(a=>`${a.fecha}_${Math.round(a.cantidad)}`));d[id].forEach(r=>{const f=normalizeRemoteDate(r.fecha),k=`${f}_${Math.round(r.cantidad)}`;if(!ex.has(k)){l[id].push({fecha:f,cantidad:Math.round(r.cantidad)});ex.add(k);}});}setStorage('anticipos_data_v3',l);updateAllUI();showToast('Listo');}catch(e){showToast(e.message,'danger');}}
            
            ui.uploadAllAnticiposBtn.onclick = handleUploadAllAnticipos;

            // Iniciar
            syncData(); 
            setInterval(syncData, 3600000);
        });
    </script>
</body>
</html>