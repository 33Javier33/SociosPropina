<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Propina (Saldo Anterior + Menu Fix)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        :root{--menu-width:250px;--primary-color:#3498db;--primary-hover-color:#2980b9;--secondary-color:#2ecc71;--danger-color:#e74c3c;--warning-color:#f39c12;--light-bg:#eef2f6;--white-bg:#fff;--text-dark:#2c3e50;--text-light:#555;--border-color:#e0e6ed}body{font-family:'Poppins',sans-serif;margin:0;background-color:var(--light-bg);color:#333}.menu-toggle{position:fixed;top:15px;left:15px;z-index:1002;width:40px;height:40px;background-color:var(--primary-color);border:none;border-radius:8px;display:flex;flex-direction:column;justify-content:center;align-items:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.1);transition:left .3s ease}.menu-toggle span{display:block;width:22px;height:2px;background-color:#fff;margin:2px 0;transition:all .3s ease}.side-menu.open+.main-container .menu-toggle{left:calc(var(--menu-width) + 15px)}.menu-toggle.active span:nth-child(1){transform:translateY(6px) rotate(45deg)}.menu-toggle.active span:nth-child(2){opacity:0}.menu-toggle.active span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}.side-menu{position:fixed;top:0;left:0;width:var(--menu-width);height:100%;background-color:var(--text-dark);z-index:1001;transform:translateX(-100%);transition:transform .3s ease;display:flex;flex-direction:column;padding-top:60px;box-shadow:5px 0 15px rgba(0,0,0,.1)}.side-menu.open{transform:translateX(0)}.side-menu .menu-header{color:#fff;font-size:1.5em;font-weight:700;text-align:center;padding:20px 10px;border-bottom:1px solid #4a627a}.side-menu a{color:#fff;text-decoration:none;padding:15px 20px;display:block;font-size:1em;transition:background-color .2s ease,padding-left .2s ease;border-bottom:1px solid #3e5268}.side-menu a:hover,.side-menu a.active-link{background-color:var(--primary-color);padding-left:25px}.main-container{transition:margin-left .3s ease;padding:15px}.container{max-width:960px;margin:10px auto;background-color:var(--white-bg);padding:20px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.07)}h1{color:var(--text-dark);text-align:center;margin-bottom:20px;font-weight:700;font-size:1.8em;padding-top:55px}
        h2{color:var(--primary-color);margin:0 0 20px;font-weight:600;font-size:1.5em;border-bottom:2px solid var(--border-color);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center}#sync-indicator{font-size:.6em;font-weight:400;color:var(--text-light);opacity:0;transition:opacity .3s}#sync-indicator.visible{opacity:1}h3{color:var(--primary-color);margin-top:25px;margin-bottom:10px;font-size:1.4em}.content-panel{display:none}.content-panel.active{display:block;animation:fadeIn .5s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}label{display:block;margin-bottom:7px;font-weight:600;color:var(--text-light)}input[type=text],input[type=date],input[type=number],select,textarea{width:100%;padding:10px;margin-bottom:18px;border:1px solid #dcdcdc;border-radius:6px;box-sizing:border-box;font-size:1em}input:focus,select:focus,textarea:focus{border-color:var(--primary-color);outline:0;box-shadow:0 0 0 3px rgba(52,152,219,.2)}button{background-color:var(--secondary-color);color:#fff;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;font-size:1em;font-weight:600;width:100%;transition:background-color .3s ease,transform .2s ease;margin-top:8px}button:hover{background-color:#27ae60;transform:translateY(-1px)}button:disabled{background-color:#bdc3c7;cursor:not-allowed}button.cancel-btn{background-color:#95a5a6}.socios-list-container{margin-top:30px;border-top:2px solid var(--border-color)}.socio-card{padding:15px;background-color:#f7f9fc;border-radius:8px;margin-bottom:10px;border:1px solid #dbe9f5}.socio-card-info p{margin:4px 0;color:var(--text-light)}.socio-card-info p strong{color:var(--text-dark)}.socio-card-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;border-top:1px solid #e0e6ed;padding-top:10px}.socio-card-actions button{width:auto;font-size:.9em;padding:6px 10px}.socio-card-actions .edit-btn{background-color:var(--primary-color)}.socio-card-actions .delete-btn{background-color:var(--danger-color)}.socio-distribucion-card{background-color:#f7f9fc;border:1px solid #dbe9f5;border-radius:10px;padding:18px;box-shadow:0 4px 15px rgba(0,0,0,.06)}.anticipos-list-container{margin-top:15px;padding-top:10px;border-top:1px dashed var(--border-color)}.anticipos-list-container h4{margin:0 0 10px;font-size:1em;color:var(--text-dark)}.anticipo-item,.descuento-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-size:.9em;border-bottom:1px solid #eef2f6}.anticipo-item:last-child,.descuento-item:last-child{border-bottom:none}.anticipo-item-info,.descuento-item-info{display:flex;flex-direction:column;flex-grow:1}.anticipo-item-info span,.descuento-item-info span{color:var(--text-light)}.anticipo-item-info .monto,.descuento-item-info .monto{font-weight:600;color:var(--text-dark)}.descuento-item-info .categoria{font-size:0.85em;font-style:italic;color:var(--primary-color)}.anticipo-item-actions,.descuento-item-actions{display:flex;gap:5px}.anticipo-item-actions button,.descuento-item-actions button{font-size:.8em;padding:4px 8px;margin:0;width:auto}.anticipo-item-actions .edit-anticipo-btn,.descuento-item-actions .edit-descuento-btn{background-color:var(--warning-color)}.anticipo-item-actions .delete-anticipo-btn,.descuento-item-actions .delete-descuento-btn{background-color:var(--danger-color)}.general-total{background-color:var(--secondary-color);color:#fff;padding:12px 15px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:1.3em;font-weight:700}
        .action-button-group{display: grid;grid-template-columns: repeat(2, 1fr);gap: 10px;margin: 15px 0;}
        @media (min-width: 768px) { .action-button-group { grid-template-columns: repeat(3, 1fr); } #saveAllAnticiposAndDistribucionBtn { grid-column: span 2; } }
        @media (min-width: 992px) { .action-button-group { grid-template-columns: repeat(4, 1fr); } #saveAllAnticiposAndDistribucionBtn { grid-column: span 2; } }
        .show-punto-planta-btn{background-color:#9b59b6}#addAnticipoBtn{background-color:var(--primary-color)}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center;animation:fadeInModal .3s}@keyframes fadeInModal{from{opacity:0}to{opacity:1}}.modal-content{background-color:#fefefe;padding:25px;border-radius:10px;width:90%;max-width:450px;text-align:center}.modal-content h3,.modal-content p,.modal-content label{text-align:left}.modal-content .modal-actions{display:flex;justify-content:space-around;margin-top:20px}.modal-content .modal-actions button{width:45%}.close-button{position:absolute;top:10px;right:15px;color:#aaa;font-size:28px;font-weight:700;cursor:pointer}#balanceReport{padding:15px;border-radius:8px;background-color:#f8f9fa}#balanceReport p{margin:0;padding:8px 0;display:flex;justify-content:space-between;font-size:1.1em}#balanceReport p strong{color:var(--text-dark)}#balanceReport .balance-saldo.negative{color:var(--danger-color)}#balanceReport hr{border:0;border-top:1px solid var(--border-color);margin:8px 0}.anticipo-socio-info{background-color:#e6f7ff;border:1px solid #91d5ff;border-radius:8px;padding:15px;margin:20px 0}.anticipo-socio-info .saldo-disponible.negative span{color:var(--danger-color)}#toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:2000;display:flex;flex-direction:column;align-items:center;gap:10px}.toast{background-color:var(--text-dark);color:#fff;padding:12px 20px;border-radius:25px;box-shadow:0 4px 15px rgba(0,0,0,.1);font-size:.9em;font-weight:500;opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease}.toast.show{opacity:1;transform:translateY(0)}.toast.success{background-color:var(--secondary-color)}.toast.danger{background-color:var(--danger-color)}.part-time-actions{display:flex;flex-direction:column;gap:8px;margin-top:10px;border-top:1px solid var(--border-color);padding-top:10px}.part-time-actions button{width:100%;padding:8px;font-size:.85em}.part-time-actions .calendar-btn{background-color:#f39c12}.part-time-actions .calculate-btn{background-color:#1abc9c}.distribucion-part-time-container .puntos-calculados-pt{font-weight:700;color:#16a085}
        .socio-distribucion-card .individual-actions {display: flex;gap: 10px;margin-top: 15px;padding-top: 10px;border-top: 1px solid #e0e6ed;}
        .socio-distribucion-card .individual-actions button {flex: 1;padding: 8px 10px;font-size: 0.9em;margin-top: 0; }
        .socio-distribucion-card .upload-anticipos-btn {background-color: #f39c12; }
        .socio-distribucion-card .upload-anticipos-btn:hover {background-color: #e67e22; }
        .socio-distribucion-card .download-anticipos-btn {background-color: #3498db; }
        .socio-distribucion-card .download-anticipos-btn:hover {background-color: #2980b9; }
        #loadAllAnticiposBtn {background-color: #34495e;} #loadAllAnticiposBtn:hover {background-color: #2c3e50;}
        #uploadAllAnticiposBtn {background-color: #e67e22;} #uploadAllAnticiposBtn:hover {background-color: #d35400;}
        #saveAllAnticiposAndDistribucionBtn {background-color: #27ae60;} #saveAllAnticiposAndDistribucionBtn:hover {background-color: #1e8449;}
        #resetPuntoPlantaBtn {background-color: #c0392b;} #resetPuntoPlantaBtn:hover {background-color: #a93226;}
        #resetPartTimeDataBtn {background-color: #e74c3c; width: 100%; margin-bottom: 15px;} #resetPartTimeDataBtn:hover {background-color: #c0392b;}
        .side-menu a.arqueo-link {background-color: #e67e22;} .side-menu a.arqueo-link:hover {background-color: #d35400; padding-left: 25px;}
        .filtros-container{margin-bottom: 25px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--light-bg);}
        .filtros-container h3 {margin-top: 0; margin-bottom: 10px; border-bottom: none; color: var(--text-dark); font-size: 1.2em;}
        .filtros-grid {display: grid; grid-template-columns: 1fr; gap: 15px;}
        @media (min-width: 600px) { .filtros-grid { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 992px) { .filtros-grid { grid-template-columns: 1fr 1fr 1fr; } }
        .socio-card-info p.puntos-info {font-size: 0.9em;color: var(--text-dark);background-color: #eafaf1;padding: 5px 8px;border-radius: 4px;margin: 6px 0;border-left: 3px solid var(--secondary-color);}
        .socio-card-info p.puntos-info strong {font-weight: 700;}
        .socio-card-info p.fecha-ingreso-info {font-size: 0.9em;color: var(--primary-color);margin: 4px 0;}
        
        .distribucion-planta-container, .distribucion-part-time-container { display: block; margin-top: 15px; }
        .area-section-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 18px; margin-bottom: 30px; }
        .area-header { background-color: #eef2f6; color: var(--text-dark); padding: 8px 15px; border-left: 4px solid var(--primary-color); border-radius: 4px; margin-bottom: 15px; font-size: 1.1em; font-weight: 700; }
        
        .calendar-discount-btn { background-color: #e67e22; width: 100%; margin-top: 8px; font-size: 0.85em; }
        .calendar-discount-btn:hover { background-color: #d35400; }
        .ausencias-info { color: #c0392b; font-weight: 600; font-size: 0.9em; margin-bottom: 5px; display: block;}
        
        /* ESTILO PARA BOTON SALDO ANTERIOR */
        .edit-saldo-anterior-btn {
            background: none; border: none; cursor: pointer; font-size: 1.1em; padding: 0 5px; color: var(--primary-color); width: auto; display: inline-block; margin: 0;
        }
        .saldo-anterior-row {
            display: flex; justify-content: space-between; align-items: center; background-color: #fff8e1; padding: 5px 8px; border-radius: 4px; margin: 5px 0; border: 1px solid #ffe082;
        }

        @media (min-width:992px){.menu-toggle{display:none}.side-menu{transform:translateX(0)}.main-container{margin-left:var(--menu-width)}.container h1{padding-top:0}}
    </style>
</head>
<body>
    <nav id="sideMenu" class="side-menu">
        <div class="menu-header">Men√∫</div>
        <a href="https://arqueo-teal.vercel.app/" class="menu-link arqueo-link" target="_blank">üí∞ Ir a Arqueo (Hoja de C√°lculo)</a>
        <a href="#" class="menu-link active-link" data-target="balanceContent">Balance General</a>
        <a href="#" class="menu-link" data-target="registroContent">Gestionar Socios</a>
        <a href="#" class="menu-link" data-target="distribucionContent">Distribuci√≥n de Propina</a>
    </nav>
    <div class="main-container" id="mainContainer">
        <button class="menu-toggle" id="menuToggle"><span></span><span></span><span></span></button>
        <div class="container">
            <h1>Gesti√≥n de Propina</h1>
            <div id="balanceContent" class="content-panel active">
                <h2><span>Balance General</span><span id="sync-indicator"></span></h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" id="syncDataBtn" style="background-color: #34495e; flex: 1;">
                        üîÑ Sincronizar (Propinas + Recaudaciones)
                    </button>
                    <button type="button" id="resetAnticiposLocalBtn" style="background-color: var(--danger-color); flex: 1;">
                        üóëÔ∏è Limpiar Anticipos Local (Residuos)
                    </button>
                </div>
                <div id="balanceReport">
                    <p><strong>Total Recaudado (Script):</strong> <span id="balancePropinaBruta">$0</span></p>
                    <p><strong>(-) Descuentos Operacionales:</strong> <span id="balanceDescuentos">$0</span></p>
                    <hr>
                    <p><strong>(=) Propina Neta a Distribuir:</strong> <span id="balancePropinaNeta">$0</span></p>
                    <p><strong>(-) Total Anticipos:</strong> <span id="balanceAnticipos">$0</span></p>
                    <hr>
                    <p><strong>Saldo Final Disponible:</strong> <span id="balanceSaldo" class="balance-saldo">$0</span></p>
                </div>
                <button type="button" id="addDescuentoBtn" style="background-color: var(--warning-color); margin-top: 20px;">Registrar Descuento Operacional</button>
                <div id="descuentosListContainer" style="margin-top: 20px;"></div>
                
                <div id="ultimaDistribucionReport" style="margin-top: 20px; padding: 15px; border-radius: 8px; background-color: #ffeae8; border: 1px solid #d9534f; display: none;">
                    <h3>√öltima Distribuci√≥n Guardada</h3>
                    <p><strong>Fecha de Corte:</strong> <span id="ultimaDistFecha">N/A</span></p>
                    <p><strong>Propina Neta:</strong> <span id="ultimaDistNeta">$0</span></p>
                    <p><strong>Punto Planta:</strong> <span id="ultimaDistPunto">$0</span></p>
                    <button id="cargarDatosDistribucionBtn" style="margin-top:10px; background-color:#d9534f;">‚ö†Ô∏è Cargar Datos de Esta Distribuci√≥n</button>
                </div>
            </div>
            <div id="registroContent" class="content-panel">
                <h2>Gestionar Socios</h2>
                <button type="button" id="showRegisterSocioModalBtn" style="background-color: var(--primary-color); margin-bottom: 20px;">
                    ‚ûï Registrar Nuevo Socio
                </button>
                <div id="filtrosGestion" class="filtros-container">
                    <h3>Filtrar Socios</h3>
                    <div class="filtros-grid">
                        <div>
                            <label for="filtroNombreGestion">Buscar por Nombre/Apellido:</label>
                            <input type="text" id="filtroNombreGestion" placeholder="Ej: Juan P√©rez" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label for="filtroAreaGestion">Filtrar por √Årea:</label>
                            <select id="filtroAreaGestion" style="margin-bottom: 0;">
                                <option value="todos">Todas las √Åreas</option>
                                <option value="Mesas">Mesas</option>
                                <option value="Maquinas">M√°quinas</option>
                                <option value="Boveda">Boveda</option>
                            </select>
                        </div>
                        <div>
                            <label for="filtroContratoGestion">Filtrar por Contrato:</label>
                            <select id="filtroContratoGestion" style="margin-bottom: 0;">
                                <option value="todos">Todos los Contratos</option>
                                <option value="Planta">Planta</option>
                                <option value="Part-Time">Part-Time</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="socios-list-container">
                    <h3>Lista de Socios</h3>
                    <div id="sociosListContainer"></div>
                </div>
            </div>
            <div id="distribucionContent" class="content-panel">
                <h2>Distribuci√≥n de Propina</h2>
                
                <div id="filtrosDistribucion" class="filtros-container">
                    <h3>Filtros R√°pidos de Socios</h3>
                    <div class="filtros-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="filtroNombre">Buscar por Nombre/Apellido:</label>
                            <input type="text" id="filtroNombre" placeholder="Ej: Juan P√©rez" style="margin-bottom: 0;">
                        </div>
                        <div>
                            <label for="filtroArea">Filtrar por √Årea:</label>
                            <select id="filtroArea" style="margin-bottom: 0;">
                                <option value="todos">Todas las √Åreas</option>
                                <option value="Mesas">Mesas</option>
                                <option value="Maquinas">M√°quinas</option>
                                <option value="Boveda">Boveda</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label for="filtroContrato">Filtrar por Contrato:</label>
                        <select id="filtroContrato" style="margin-bottom: 0;">
                            <option value="todos">Todos los Contratos</option>
                            <option value="Planta">Planta</option>
                            <option value="Part-Time">Part-Time</option>
                        </select>
                    </div>
                </div>
                <div class="general-total" id="totalGeneralPropinaNetaDistribucion"></div>
                <div id="totalPuntosDisplay" style="text-align:center; font-weight:bold; background-color:#eafaf1; padding:10px; border-radius:8px; margin-top: 15px; margin-bottom: 15px; border: 1px solid #c3e6cb;"></div>
                <div class="punto-planta-display-general" id="puntoPlantaDisplay"></div>
                
                <div class="action-button-group">
                    <button type="button" class="show-punto-planta-btn">Obtener Valor Punto-Planta</button>
                    <button type="button" id="resetPuntoPlantaBtn">üî¥ Reiniciar Valor Punto-Planta</button>
                    <button type="button" id="addAnticipoBtn">Registrar Nuevo Anticipo</button>
                    <button type="button" id="loadAllAnticiposBtn">üì• Cargar Todos los Anticipos (Sheets)</button>
                    <button type="button" id="uploadAllAnticiposBtn" style="background-color: #f39c12;">
                        ‚¨ÜÔ∏è Subir Todos los Anticipos a Sheets
                    </button>
                    <button type="button" id="saveAllAnticiposAndDistribucionBtn" style="background-color: #27ae60;">
                        üíæ Guardar Distribuci√≥n Final y Limpiar
                    </button>
                </div>
                <button type="button" id="resetPartTimeDataBtn">üî¥ Reiniciar D√≠as PT y Ausencias Planta</button>

                <div id="distribucionPlantaContainer"></div>
                <div id="distribucionPartTimeContainer"></div>
            </div>
        </div>
    </div>
    <div id="modal-container"></div>
    <div id="toast-container"></div>
    
    <!-- Templates -->
    <template id="templateRegisterSocioModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Registrar Nuevo Socio</h3>
                <form id="registroSocioFormModal">
                    <label for="nombre">Nombre:</label><input type="text" id="nombre" required>
                    <label for="apellido">Apellido:</label><input type="text" id="apellido" required>
                    <label for="fechaIngreso">Fecha de Ingreso:</label><input type="date" id="fechaIngreso" required>
                    <label for="area">√Årea:</label><select id="area" required><option value="">Seleccione</option><option value="Mesas">Mesas</option><option value="Maquinas">M√°quinas</option><option value="Boveda">Boveda</option></select>
                    <label for="tipoContrato">Contrato:</label><select id="tipoContrato" required><option value="">Seleccione</option><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select>
                    <button type="submit">Registrar Socio</button>
                </form>
            </div>
        </div>
    </template>
    
    <template id="templateAddAnticipoModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Registrar Anticipo</h3>
                <form id="registroAnticipoForm">
                    <label for="anticipoSocioInput">Seleccionar Socio:</label><input list="sociosAnticipoList" id="anticipoSocioInput" type="text" placeholder="Buscar socio..." required>
                    <datalist id="sociosAnticipoList"></datalist>
                    <input type="hidden" id="anticipoSocioId">
                    <div id="anticipoSocioInfoContainer" class="anticipo-socio-info" style="display: none;">
                        <h4>Info Socio</h4>
                        <p><strong>Propina Asignada:</strong> <span id="infoPropinaAsignada">$0</span></p>
                        <p><strong>Anticipos Anteriores:</strong> <span id="infoAnticiposAnteriores">$0</span></p>
                        <p class="saldo-disponible"><strong>Saldo Disponible:</strong> <span id="infoSaldoDisponible">$0</span></p>
                    </div>
                    <label for="anticipoFecha">Fecha:</label><input type="date" id="anticipoFecha" required>
                    <label for="anticipoCantidad">Monto:</label><input type="text" id="anticipoCantidad" inputmode="numeric" required>
                    <button type="submit">Registrar Anticipo</button>
                </form>
            </div>
        </div>
    </template>

    <template id="templatePuntoPlantaModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Calcular Valor Punto-Planta</h3>
                <div>
                    <div id="propinaNetaContainer">
                        <p style="text-align:left;"><strong>Propina Neta:</strong> <span id="propinaNetaModal">$0</span></p>
                    </div>
                    <div id="divisorPuntosContainer">
                        <p style="text-align:left;"><strong>Total Puntos:</strong> <span id="totalPuntosGeneralDisplay" style="color:#28a745;">0</span></p>
                    </div>
                    <hr>
                    <label for="divisorManualInput">Divisor Manual:</label>
                    <input type="text" id="divisorManualInput" placeholder="0.00">
                    <p style="text-align:left; margin-top: 15px;"><strong>Valor Punto:</strong> <strong id="valorPuntoCalculadoDisplay" style="color:var(--primary-color);">$0</strong></p>
                    <button type="button" id="calcularPuntoPlantaInternoBtn">Calcular y Guardar</button>
                    <div id="puntoPlantaValor" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="templateAddDescuentoModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Registrar Descuento</h3>
                <form id="registroDescuentoForm">
                    <input type="hidden" id="descuentoId">
                    <label for="descuentoCategoria">Categor√≠a:</label>
                    <select id="descuentoCategoria" required>
                        <option value="Caja Chica">Caja Chica</option>
                        <option value="Falla Operacional">Falla Operacional</option>
                        <option value="Gastos Materiales">Gastos Materiales</option>
                        <option value="Otro">Otro (Especificar)</option>
                    </select>
                    <input type="text" id="descuentoCategoriaOtro" placeholder="Especifique otra categor√≠a" style="display:none; margin-top: -10px; margin-bottom: 18px;">
                    <label for="descuentoDescripcion">Descripci√≥n:</label>
                    <textarea id="descuentoDescripcion" rows="2" required></textarea>
                    <label for="descuentoCantidad">Monto:</label>
                    <input type="text" id="descuentoCantidad" inputmode="numeric" required>
                    <button type="submit">Guardar</button>
                </form>
            </div>
        </div>
    </template>

    <template id="templateEditSocioModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Editar Socio</h3>
                <form id="editSocioForm">
                    <input type="hidden" id="editSocioId">
                    <label for="editNombre">Nombre:</label><input type="text" id="editNombre" required>
                    <label for="editApellido">Apellido:</label><input type="text" id="editApellido" required>
                    <label for="editFechaIngreso">Fecha de Ingreso:</label><input type="date" id="editFechaIngreso" required>
                    <label for="editArea">√Årea:</label><select id="editArea" required><option value="Mesas">Mesas</option><option value="Maquinas">Maquinas</option><option value="Boveda">Boveda</option></select>
                    <label for="editTipoContrato">Contrato:</label><select id="editTipoContrato" required><option value="Planta">Planta</option><option value="Part-Time">Part-Time</option></select>
                    <button type="submit">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </template>
    
    <template id="templateEditAnticipoModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Editar Anticipo</h3>
                <form id="editAnticipoForm">
                    <input type="hidden" id="editSocioId">
                    <input type="hidden" id="editAnticipoIndex">
                    <label for="editAnticipoFecha">Fecha:</label><input type="date" id="editAnticipoFecha" required>
                    <label for="editAnticipoCantidad">Monto:</label><input type="text" id="editAnticipoCantidad" inputmode="numeric" required>
                    <button type="submit">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </template>

    <template id="templateEditSaldoAnteriorModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3>Editar Saldo Anterior</h3>
                <form id="editSaldoAnteriorForm">
                    <input type="hidden" id="editSaldoSocioId">
                    <label for="editSaldoMonto">Monto (Deuda o Saldo a Favor):</label>
                    <input type="text" id="editSaldoMonto" inputmode="numeric" required placeholder="0">
                    <button type="submit">Guardar Saldo</button>
                </form>
            </div>
        </div>
    </template>

    <template id="templateConfirmDeleteModal">
        <div class="modal">
            <div class="modal-content">
                <h3>Confirmar Acci√≥n</h3>
                <p id="confirmDeleteText"></p>
                <div class="modal-actions">
                    <button class="cancel-btn">Cancelar</button>
                    <button class="delete-btn confirm-delete-btn">Confirmar</button>
                </div>
            </div>
        </div>
    </template>
    
    <template id="templateCalendarModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3 id="calendarModalTitle">D√≠as</h3>
                <input type="text" id="flatpickrInput" placeholder="Selecciona d√≠as...">
                <p style="text-align:center; margin-top:15px;">D√≠as seleccionados: <strong id="selectedDaysCount">0</strong></p>
                <p id="montoDescuentoInfo" style="text-align:center; margin-top:5px; display:none; color:var(--danger-color); font-weight:bold; font-size:0.9em;"></p>
                <button id="saveCalendarBtn">Guardar</button>
            </div>
        </div>
    </template>
    
    <template id="templatePartTimePointsModal">
        <div class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span><h3 id="partTimePointsModalTitle">Calcular Puntos</h3>
                <p><strong>Puntos Base:</strong> <span id="partTimeModalBasePoints">0</span></p>
                <p><strong>Monto Asignable:</strong> <span id="partTimeModalAssignableAmount">$0</span></p><hr>
                <label for="partTimeMultiplicador">Divisor de Puntos:</label>
                <input type="text" id="partTimeMultiplicador" inputmode="numeric" required>
                <button type="button" id="calculatePartTimePointsInternoBtn">Calcular</button>
                <div id="partTimePointsValue" style="text-align:center; margin-top:15px; font-weight:bold;"></div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // *** CONFIGURACI√ìN URLS - ASEG√öRATE DE QUE SEAN LAS TUYAS ***
            const SCRIPT_URL_SOCIOS = 'https://script.google.com/macros/s/AKfycbyr447pMQtsKoBfp8qTcB1uyE3rORhgPPmZM6Fgia3BgmIvtlZ_h04uGZrmx_HwubHQ/exec'; 
            const SCRIPT_URL_RECAUDACIONES = 'https://script.google.com/macros/s/AKfycbz_kCb4aEe437zHGbRqnjCibw1NtAqfCbTNmsVPn9jaZOPBFaZ6-FwmiTLqVxq39X1P/exec'; 

            const ui = {
                menuToggle: document.getElementById('menuToggle'),
                sideMenu: document.getElementById('sideMenu'),
                mainContainer: document.getElementById('mainContainer'),
                toastContainer: document.getElementById('toast-container'),
                modalContainer: document.getElementById('modal-container'),
                syncIndicator: document.getElementById('sync-indicator'),
                syncDataBtn: document.getElementById('syncDataBtn'), 
                resetAnticiposLocalBtn: document.getElementById('resetAnticiposLocalBtn'),
                resetPuntoPlantaBtn: document.getElementById('resetPuntoPlantaBtn'),
                resetPartTimeDataBtn: document.getElementById('resetPartTimeDataBtn'),
                balancePropinaBruta: document.getElementById('balancePropinaBruta'),
                balanceDescuentos: document.getElementById('balanceDescuentos'),
                balancePropinaNeta: document.getElementById('balancePropinaNeta'),
                balanceAnticipos: document.getElementById('balanceAnticipos'),
                balanceSaldo: document.getElementById('balanceSaldo'),
                totalGeneralPropinaNetaDistribucion: document.getElementById('totalGeneralPropinaNetaDistribucion'),
                puntoPlantaDisplay: document.getElementById('puntoPlantaDisplay'),
                distribucionPlantaContainer: document.getElementById('distribucionPlantaContainer'),
                distribucionPartTimeContainer: document.getElementById('distribucionPartTimeContainer'),
                sociosListContainer: document.getElementById('sociosListContainer'),
                descuentosListContainer: document.getElementById('descuentosListContainer'),
                showRegisterSocioModalBtn: document.getElementById('showRegisterSocioModalBtn'),
                ultimaDistribucionReport: document.getElementById('ultimaDistribucionReport'),
                ultimaDistFecha: document.getElementById('ultimaDistFecha'),                 
                ultimaDistNeta: document.getElementById('ultimaDistNeta'),                   
                ultimaDistPunto: document.getElementById('ultimaDistPunto'), 
                cargarDatosDistribucionBtn: document.getElementById('cargarDatosDistribucionBtn'),
                totalPuntosDisplay: document.getElementById('totalPuntosDisplay'),
                loadAllAnticiposBtn: document.getElementById('loadAllAnticiposBtn'), 
                uploadAllAnticiposBtn: document.getElementById('uploadAllAnticiposBtn'), 
                saveAllAnticiposAndDistribucionBtn: document.getElementById('saveAllAnticiposAndDistribucionBtn'),
                filtroNombre: document.getElementById('filtroNombre'),
                filtroArea: document.getElementById('filtroArea'),
                filtroContrato: document.getElementById('filtroContrato'),
                filtroNombreGestion: document.getElementById('filtroNombreGestion'),
                filtroAreaGestion: document.getElementById('filtroAreaGestion'),
                filtroContratoGestion: document.getElementById('filtroContratoGestion'),
            };

            let isSyncing = false;
            let sociosData = [];
            let montosData = []; 
            let recaudacionPorDia = {}; 
            let ultimaDistribucionData = null; 
            let flatpickrInstance = null;
            
            const formatDisplayDate = (d) => { if(!d || !/^\d{4}-\d{2}-\d{2}/.test(d)) return d; const [y,m,day]=d.split('T')[0].split('-'); return `${day.padStart(2,'0')}-${m.padStart(2,'0')}-${y}`; };
            const showToast = (msg, type='success') => {
                const t = document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg; ui.toastContainer.appendChild(t);
                setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove())},4000);
            };
            const formatNumber = (n) => new Intl.NumberFormat('es-CL').format(Math.round(n)||0);
            const parseNumber = (s) => parseFloat(String(s).replace(/\./g,'').replace(',','.'))||0;
            const getStorage = (k) => JSON.parse(localStorage.getItem(k))||(k.includes('anticipos')?{}:k.includes('descuentos')?[]:{});
            const setStorage = (k,v) => localStorage.setItem(k,JSON.stringify(v));
            
            // NUEVA FUNCI√ìN PARA NORMALIZAR FECHAS DE SHEETS A YYYY-MM-DD
            const normalizeRemoteDate = (dateStr) => {
                if (!dateStr) return '';
                // Intentar convertir la cadena (ej: "Sun Jan 18 2026...") a objeto Date
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr; // Si falla, devolver original
                
                // Formatear manualmente a YYYY-MM-DD usando fecha local
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            };
            
            function setupNumericInputFormatting(el) { if(!el)return; el.addEventListener('input', e=>{ let v=e.target.value.replace(/\./g,''); e.target.value=isNaN(v)||v.trim()===''?'':new Intl.NumberFormat('es-CL').format(parseInt(v,10)); }); }
            
            const calcPuntos = (f) => {
                if(!f) return 4; const fi=new Date(f); if(isNaN(fi)) return 4;
                const h=new Date(); let a=h.getFullYear()-fi.getFullYear();
                if(h.getMonth()<fi.getMonth() || (h.getMonth()===fi.getMonth() && h.getDate()<fi.getDate())) a--;
                return 4+(Math.max(0,a)*2);
            };
            const isPartTime = (s) => (s.TipoContrato||'').toLowerCase().trim()==='part-time';
            const calcTope = (s) => Math.min(s.puntosAntiguedad, s.Area==='Mesas'?20:s.Area==='Boveda'?10:12);
            
            const updateAllUI = () => {
                const bruto = Object.values(recaudacionPorDia).reduce((a,b)=>a+b,0);
                const desc = getStorage('descuentos_operacionales_v1');
                const totalDesc = desc.reduce((s,d)=>s+d.cantidad,0);
                const neta = bruto-totalDesc;
                const ants = getStorage('anticipos_data_v3');
                let totalAnts = 0; Object.values(ants).forEach(l=>totalAnts+=l.reduce((s,a)=>s+a.cantidad,0));
                const saldo = neta-totalAnts;

                ui.balancePropinaBruta.textContent=`$${formatNumber(bruto)}`; ui.balanceDescuentos.textContent=`$${formatNumber(totalDesc)}`;
                ui.balancePropinaNeta.textContent=`$${formatNumber(neta)}`; ui.balanceAnticipos.textContent=`$${formatNumber(totalAnts)}`;
                ui.balanceSaldo.textContent=`$${formatNumber(saldo)}`; ui.balanceSaldo.classList.toggle('negative',saldo<0);
                ui.totalGeneralPropinaNetaDistribucion.textContent=`Propina a Distribuir: $${formatNumber(neta)}`;

                let pPlanta=0, pPT=0; 
                const ptData = getStorage('part_time_data_v3');
                const plantaAbs = getStorage('planta_absences_v1'); 
                const valPunto = parseFloat(localStorage.getItem('lastPuntoPlantaValue'))||0;

                sociosData.forEach(s => {
                    if(isPartTime(s)) {
                        const d = ptData[s.ID]||{}; pPT+=s.puntosAntiguedad;
                        s.propinaAsignada = s.puntosAntiguedad * (d.puntosCalculados||0);
                        s.puntosAsignadosFinales = s.puntosAntiguedad;
                    } else {
                        let dineroPerdido = 0;
                        (plantaAbs[s.ID]||[]).forEach(dia => dineroPerdido += (recaudacionPorDia[dia] || 0));
                        let factor = bruto > 0 ? (1 - (dineroPerdido / bruto)) : 1;
                        if(factor < 0) factor = 0;
                        const pf = calcTope(s) * factor;
                        pPlanta+=pf;
                        s.propinaAsignada = pf * valPunto;
                        s.puntosAsignadosFinales = pf;
                        s.dineroDescontado = dineroPerdido;
                    }
                });

                ui.totalPuntosDisplay.innerHTML=`Puntos Totales: <strong>${(pPlanta+pPT).toFixed(2)}</strong> (Planta:${pPlanta.toFixed(2)} + PT:${pPT.toFixed(2)})`;
                ui.puntoPlantaDisplay.innerHTML = valPunto>0 ? `<p style="text-align:center;font-weight:bold;background:#f0f9ff;padding:10px;">Valor Punto: $${formatNumber(valPunto)}</p>` : '<p style="text-align:center;color:var(--danger-color);">‚ö†Ô∏è Valor Punto no establecido.</p>';

                renderSociosFiltrados(); renderDescuentos(desc);
                if(ultimaDistribucionData?.resumen) {
                    ui.ultimaDistFecha.textContent=ultimaDistribucionData.resumen.fecha;
                    ui.ultimaDistNeta.textContent=`$${formatNumber(ultimaDistribucionData.resumen.propinaNeta)}`;
                    ui.ultimaDistPunto.textContent=`$${formatNumber(ultimaDistribucionData.resumen.puntoPlanta)}`;
                    ui.ultimaDistribucionReport.style.display='block';
                } else ui.ultimaDistribucionReport.style.display='none';
            };

            const renderSociosFiltrados = () => {
                const fN=ui.filtroNombre.value.toLowerCase(), fA=ui.filtroArea.value, fC=ui.filtroContrato.value;
                const fNG=ui.filtroNombreGestion.value.toLowerCase(), fAG=ui.filtroAreaGestion.value, fCG=ui.filtroContratoGestion.value;
                const filterFn = (s, n, a, c) => `${s.Nombre} ${s.Apellido}`.toLowerCase().includes(n) && (a==='todos'||s.Area===a) && (c==='todos'||s.TipoContrato===c);
                renderSocios(sociosData.filter(s=>filterFn(s,fNG,fAG,fCG)), sociosData.filter(s=>filterFn(s,fN,fA,fC)));
            };

            const renderSocios = (gest, dist) => {
                ui.sociosListContainer.innerHTML='';
                if(gest.length===0) ui.sociosListContainer.innerHTML='<p>No hay socios.</p>';
                else {
                    const grp = gest.reduce((a,s)=>{ let k=s.Area; if(!a[k])a[k]=[]; a[k].push(s); return a;},{});
                    ['Mesas','Maquinas','Boveda'].forEach(area => {
                        if(grp[area]) {
                            const div=document.createElement('div'); div.innerHTML=`<h3 style="margin-top:30px; border-bottom:1px solid #ddd">${area}</h3>`;
                            grp[area].forEach(s=>div.appendChild(createCard(s, 'manage')));
                            ui.sociosListContainer.appendChild(div);
                        }
                    });
                }

                ui.distribucionPlantaContainer.innerHTML=''; ui.distribucionPartTimeContainer.innerHTML='';
                const planta = dist.filter(s=>!isPartTime(s)); const pt = dist.filter(isPartTime);
                
                const renderPorArea = (lista, container, tituloVacio) => {
                    if(lista.length===0) { container.innerHTML=`<p style="color:#777;font-style:italic;">${tituloVacio}</p>`; return; }
                    const grp = lista.reduce((a,s)=>{ let k=s.Area; if(!a[k])a[k]=[]; a[k].push(s); return a;},{});
                    
                    ['Mesas','Maquinas','Boveda'].forEach(area => {
                        if(grp[area]) {
                            // C√ÅLCULO DE PUNTOS TOTALES POR √ÅREA (filtrados)
                            const totalAreaPts = grp[area].reduce((acc, curr) => acc + (curr.puntosAsignadosFinales || 0), 0);
                            
                            const header = document.createElement('div'); 
                            header.className='area-header'; 
                            // SE A√ëADE SPAN CON TOTAL DE PUNTOS
                            header.innerHTML=`${area} <span style="float:right; font-weight:normal; font-size:0.9em;">Total Puntos: <strong>${totalAreaPts.toFixed(2)}</strong></span>`;
                            
                            const grid = document.createElement('div'); grid.className='area-section-grid';
                            grp[area].forEach(s=>grid.appendChild(createCard(s, 'dist')));
                            container.appendChild(header); container.appendChild(grid);
                        }
                    });
                };
                
                ui.distribucionPlantaContainer.innerHTML='<h3>Socios Planta</h3>'; renderPorArea(planta, ui.distribucionPlantaContainer, "Sin socios Planta.");
                ui.distribucionPartTimeContainer.innerHTML='<h3>Socios Part-Time</h3>'; renderPorArea(pt, ui.distribucionPartTimeContainer, "Sin socios Part-Time.");
                updatePropinaUI();
            };

            const createCard = (s, type) => {
                const card = document.createElement('div'); 
                if(type==='manage') {
                    card.className='socio-card';
                    const ptData = getStorage('part_time_data_v3')[s.ID]||{};
                    const extra = isPartTime(s) ? `<p><strong>D√≠as:</strong> ${(ptData.diasTrabajados||[]).length}</p><div class="part-time-actions"><button class="calendar-btn" data-socio-id="${s.ID}">Registrar D√≠as</button><button class="calculate-btn" data-socio-id="${s.ID}">Calcular Puntos</button></div>` : '';
                    card.innerHTML = `<div class="socio-card-info"><p><strong>${s.Nombre} ${s.Apellido}</strong></p><p>${s.Area} - ${s.TipoContrato}</p><p class="fecha-ingreso-info">Ingreso: ${formatDisplayDate(s.FechaIngreso)}</p>${extra}</div><div class="socio-card-actions"><button class="edit-btn" data-socio-id="${s.ID}">‚úèÔ∏è</button><button class="delete-btn" data-socio-id="${s.ID}">üóëÔ∏è</button></div>`;
                } else {
                    card.className='socio-distribucion-card'; card.dataset.socioId=s.ID;
                    let ptsDisplay = ''; let actionBtn = '';
                    if(isPartTime(s)) {
                        ptsDisplay = `Puntos Base: ${s.puntosAntiguedad}`;
                    } else {
                        const ausencias = (getStorage('planta_absences_v1')[s.ID]||[]).length;
                        ptsDisplay = `Puntos Tope: ${calcTope(s)}`;
                        if(ausencias > 0) {
                            const dineroPerdido = s.dineroDescontado || 0;
                            ptsDisplay += ` <span class="ausencias-info">(-${ausencias} d√≠as / -$${formatNumber(dineroPerdido)})</span>`;
                        }
                        actionBtn = `<button class="calendar-discount-btn" data-socio-id="${s.ID}">üìÖ Marcar Ausencias</button>`;
                    }
                    // Nuevo bloque de Saldo Anterior
                    const saldoAnt = (getStorage('saldo_anterior_v1')[s.ID] || 0);
                    card.innerHTML = `<h3>${s.Nombre} ${s.Apellido}</h3>
                                      <p>${ptsDisplay}</p>
                                      <p>Asignado: <span class="propina-asignada">$0</span></p>
                                      <div class="saldo-anterior-row">
                                        <span>Saldo Ant: <strong>$${formatNumber(saldoAnt)}</strong></span>
                                        <button class="edit-saldo-anterior-btn" data-socio-id="${s.ID}">üí∞</button>
                                      </div>
                                      <p>Anticipos: <span class="total-anticipos">$0</span></p>
                                      <p>Saldo Final: <span class="saldo-disponible">$0</span></p>
                                      ${actionBtn}
                                      <div class="anticipos-container"></div>
                                      <div class="individual-actions"><button class="download-anticipos-btn" data-socio-id="${s.ID}">üì• Cargar</button><button class="upload-anticipos-btn" data-socio-id="${s.ID}">Subir</button></div>`;
                }
                return card;
            };

            const updatePropinaUI = () => {
                const ants = getStorage('anticipos_data_v3');
                const saldoAntData = getStorage('saldo_anterior_v1');
                
                sociosData.forEach(s => {
                    const c = document.querySelector(`.socio-distribucion-card[data-socio-id="${s.ID}"]`);
                    if(!c) return;
                    const antS = ants[s.ID]||[]; const totA = antS.reduce((a,b)=>a+b.cantidad,0);
                    const saldoAnt = saldoAntData[s.ID] || 0;
                    
                    c.querySelector('.propina-asignada').textContent=`$${formatNumber(s.propinaAsignada)}`;
                    c.querySelector('.total-anticipos').textContent=`$${formatNumber(totA)}`;
                    
                    // Calculo Final: Asignado - Anticipos + Saldo Anterior
                    const sal = s.propinaAsignada - totA + saldoAnt;
                    
                    const elSal = c.querySelector('.saldo-disponible'); elSal.textContent=`$${formatNumber(sal)}`; elSal.classList.toggle('negative', sal<0);
                    let html = antS.length ? `<div class="anticipos-list-container"><h4>Anticipos Locales</h4>${antS.map((a,i)=>`<div class="anticipo-item"><span class="monto">$${formatNumber(a.cantidad)} (${formatDisplayDate(a.fecha)})</span><div class="anticipo-item-actions"><button class="edit-anticipo-btn" data-socio-id="${s.ID}" data-anticipo-index="${i}">‚úèÔ∏è</button><button class="delete-anticipo-btn" data-socio-id="${s.ID}" data-anticipo-index="${i}">üóëÔ∏è</button></div></div>`).join('')}</div>` : '';
                    c.querySelector('.anticipos-container').innerHTML = html;
                });
            };
            
            const renderDescuentos = (list) => {
                ui.descuentosListContainer.innerHTML = list.length ? list.map(d => `<div class="descuento-item"><div class="descuento-item-info"><span class="monto">$${formatNumber(d.cantidad)} - ${d.descripcion}</span><span class="categoria">${d.categoria}</span></div><div class="descuento-item-actions"><button class="edit-descuento-btn" data-id="${d.id}">‚úèÔ∏è</button><button class="delete-descuento-btn" data-id="${d.id}">üóëÔ∏è</button></div></div>`).join('') : '<p>Sin descuentos.</p>';
            };

            async function apiCall(url, action, method='GET', body=null) {
                const opt = { method, mode:'cors' }; if(method!=='GET') opt.body=JSON.stringify({action, ...body});
                const r = await fetch(method==='GET'?`${url}?action=${action}`:url, opt);
                const res = await r.json(); if(res.status!=='success') throw new Error(res.message); return res.data||res;
            }

            async function fetchRecaudaciones() {
                try {
                    const res = await apiCall(SCRIPT_URL_RECAUDACIONES, 'get');
                    montosData = res; 
                    recaudacionPorDia = {}; 
                    montosData.forEach(row => {
                        if(row.fecha && row.monto) {
                            recaudacionPorDia[row.fecha] = (recaudacionPorDia[row.fecha] || 0) + parseFloat(row.monto);
                        }
                    });
                } catch(e) {
                    showToast(`Error al cargar Recaudaciones: ${e.message}`, 'danger');
                    recaudacionPorDia = {};
                }
            }

            function handleShowEditSocioModal(id) {
                const s = sociosData.find(x=>x.ID===id); if(!s) return;
                ui.modalContainer.innerHTML = document.getElementById('templateEditSocioModal').innerHTML;
                const m = ui.modalContainer.querySelector('.modal');
                const f = m.querySelector('form');
                f.editSocioId.value=s.ID; f.editNombre.value=s.Nombre; f.editApellido.value=s.Apellido;
                f.editArea.value=s.Area; f.editTipoContrato.value=s.TipoContrato;
                let d = s.FechaIngreso; if(d && d.includes('T')) d=d.split('T')[0];
                f.editFechaIngreso.value = d;
                f.onsubmit = async (e) => {
                    e.preventDefault();
                    try {
                        await apiCall(SCRIPT_URL_SOCIOS, 'updateSocio', 'POST', { socio: {
                            ID: f.editSocioId.value, Nombre: f.editNombre.value, Apellido: f.editApellido.value,
                            FechaIngreso: f.editFechaIngreso.value, Area: f.editArea.value, TipoContrato: f.editTipoContrato.value
                        }});
                        showToast('Actualizado'); m.style.display='none'; syncData();
                    } catch(err) { showToast(err.message, 'danger'); }
                };
                m.querySelector('.close-button').onclick=()=>m.style.display='none'; m.style.display='flex';
            }

            async function handleLoadAllAnticipos() {
                try {
                    showToast('Descargando...'); const data = await apiCall(SCRIPT_URL_SOCIOS, 'getAllAnticiposDesdeSheets', 'POST');
                    if(!Object.keys(data).length) { showToast('Nada pendiente.'); return; }
                    const locals = getStorage('anticipos_data_v3');
                    for(const id in data) {
                        if (!locals[id]) locals[id] = [];
                        const existingKeys = new Set(locals[id].map(a => `${a.fecha.split('T')[0]}_${Math.round(a.cantidad)}`));
                        data[id].forEach(remote => {
                            // AQU√ç SE APLICA LA NORMALIZACI√ìN DE FECHA
                            const cleanDate = normalizeRemoteDate(remote.fecha); 
                            const cleanAmt = Math.round(remote.cantidad);
                            const key = `${cleanDate}_${cleanAmt}`;
                            if (!existingKeys.has(key)) { locals[id].push({ fecha: cleanDate, cantidad: cleanAmt }); existingKeys.add(key); }
                        });
                    }
                    setStorage('anticipos_data_v3', locals); updateAllUI(); showToast('Sincronizado.');
                } catch(e) { showToast(e.message, 'danger'); }
            }
            
            async function handleDownloadAnticipos(id) {
                 try {
                    showToast('Descargando individual...');
                    const data = await apiCall(SCRIPT_URL_SOCIOS, 'getAnticiposSocioDesdeSheets', 'POST', {socioId: id});
                    if(!data || !data.length) { showToast('Sin anticipos.'); return; }
                    const locals = getStorage('anticipos_data_v3');
                    if(!locals[id]) locals[id]=[];
                    const existingKeys = new Set(locals[id].map(a => `${a.fecha.split('T')[0]}_${Math.round(a.cantidad)}`));
                    let count = 0;
                    data.forEach(remote => {
                        // AQU√ç SE APLICA LA NORMALIZACI√ìN DE FECHA
                        const cleanDate = normalizeRemoteDate(remote.fecha); 
                        const cleanAmt = Math.round(remote.cantidad);
                        const key = `${cleanDate}_${cleanAmt}`;
                        if(!existingKeys.has(key)){ locals[id].push({fecha:cleanDate, cantidad:cleanAmt}); existingKeys.add(key); count++; }
                    });
                    setStorage('anticipos_data_v3', locals); updateAllUI(); showToast(count>0 ? `Cargados ${count}` : 'Ya estaban cargados.');
                 } catch(e) { showToast(e.message, 'danger'); }
            }

            async function handleUploadAllAnticipos() {
                const all = getStorage('anticipos_data_v3');
                const list = [];
                Object.keys(all).forEach(id => {
                    const s = sociosData.find(x=>x.ID===id); if(!s) return;
                    all[id].forEach(a => list.push({ id, nombre:`${s.Nombre} ${s.Apellido}`, fecha:a.fecha, monto:Math.round(a.cantidad) }));
                });
                if(!list.length) { showToast('Nada para subir.', 'warning'); return; }
                try {
                    showToast(`Subiendo ${list.length}...`);
                    await apiCall(SCRIPT_URL_SOCIOS, 'registrarTodosLosAnticipos', 'POST', { detalleAnticipos: list });
                    showToast('Subida exitosa.');
                } catch(e) { showToast(e.message, 'danger'); }
            }
            
            async function handleSaveDistribucionFinal() {
                ui.modalContainer.innerHTML = document.getElementById('templateConfirmDeleteModal').innerHTML;
                const m = ui.modalContainer.querySelector('.modal');
                m.querySelector('#confirmDeleteText').innerHTML = "üö® <b>Guardar Distribuci√≥n y Limpiar?</b><br>Se guardar√° en Sheets y se borrar√°n los anticipos pendientes.";
                m.style.display = 'flex'; m.querySelector('.cancel-btn').onclick=()=>m.style.display='none';
                m.querySelector('.confirm-delete-btn').onclick = async () => {
                    m.style.display='none';
                    const neta = parseNumber(ui.balancePropinaNeta.textContent);
                    const punto = parseFloat(localStorage.getItem('lastPuntoPlantaValue'))||0;
                    if(punto<=0) { showToast('Falta punto planta', 'warning'); return; }
                    const ants = getStorage('anticipos_data_v3');
                    const saldoAntData = getStorage('saldo_anterior_v1');
                    
                    const detalleAnts = []; let totAnts=0;
                    const distribucion = sociosData.map(s => {
                        const l = ants[s.ID]||[]; const sumA = l.reduce((x,y)=>x+y.cantidad,0);
                        const sAnt = saldoAntData[s.ID] || 0;
                        totAnts+=sumA;
                        l.forEach(a => detalleAnts.push({id:s.ID, nombre:`${s.Nombre} ${s.Apellido}`, fecha:a.fecha, monto:Math.round(a.cantidad)}));
                        
                        // Calculo final que se envia a sheets
                        const saldoFinal = Math.round(s.propinaAsignada - sumA + sAnt);
                        
                        return { ID:s.ID, NombreCompleto:`${s.Nombre} ${s.Apellido}`, Area:s.Area, TipoContrato:s.TipoContrato, PuntosAntiguedad:s.puntosAntiguedad, PuntosFinales:s.puntosAsignadosFinales, PropinaAsignada:Math.round(s.propinaAsignada), Anticipos:Math.round(sumA), SaldoFinal:saldoFinal };
                    });
                    try {
                        showToast('Guardando...');
                        const res = await apiCall(SCRIPT_URL_SOCIOS, 'guardarDistribucion', 'POST', {
                            resumen: { fecha: new Date().toISOString().split('T')[0], propinaNeta:neta, puntoPlanta:punto, totalPuntos:parseFloat((ui.totalPuntosDisplay.innerText.match(/[\d\.]+/)||['0'])[0]), totalAnticipos:totAnts },
                            distribucion, descuentos: getStorage('descuentos_operacionales_v1'), detalleAnticipos: detalleAnts
                        });
                        showToast(`Hoja: ${res.sheetName}`); localStorage.removeItem('anticipos_data_v3'); syncData();
                    } catch(e) { showToast(e.message, 'danger'); }
                };
            }

            // =========================================================================
            // MANEJO DE SALDO ANTERIOR
            // =========================================================================
            function handleEditSaldoAnterior(socioId) {
                const s = sociosData.find(x => x.ID === socioId);
                if(!s) return;
                
                ui.modalContainer.innerHTML = document.getElementById('templateEditSaldoAnteriorModal').innerHTML;
                const m = ui.modalContainer.querySelector('.modal');
                const f = m.querySelector('form');
                const inputVal = f.querySelector('#editSaldoMonto');
                
                setupNumericInputFormatting(inputVal);
                
                // Cargar valor actual
                const current = getStorage('saldo_anterior_v1')[socioId] || 0;
                inputVal.value = formatNumber(current);
                f.querySelector('#editSaldoSocioId').value = socioId;
                
                f.onsubmit = (e) => {
                    e.preventDefault();
                    const val = parseNumber(inputVal.value);
                    const allData = getStorage('saldo_anterior_v1');
                    allData[socioId] = val;
                    setStorage('saldo_anterior_v1', allData);
                    updateAllUI();
                    m.style.display = 'none';
                    showToast('Saldo anterior actualizado');
                };
                
                // Boton cerrar
                const closeBtn = document.createElement('span'); 
                closeBtn.className = 'close-button'; 
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => m.style.display = 'none';
                m.querySelector('.modal-content').prepend(closeBtn);
                
                m.style.display = 'flex';
            }

            function setupEventListeners() {
                ui.menuToggle.onclick=e=>{e.stopPropagation();ui.sideMenu.classList.toggle('open'); ui.menuToggle.classList.toggle('active');};
                
                // CLOSE MENU ON CLICK OUTSIDE
                document.addEventListener('click', (e) => {
                    const isClickInsideMenu = ui.sideMenu.contains(e.target);
                    const isClickOnToggle = ui.menuToggle.contains(e.target);
                    if (ui.sideMenu.classList.contains('open') && !isClickInsideMenu && !isClickOnToggle) {
                        ui.sideMenu.classList.remove('open');
                        ui.menuToggle.classList.remove('active');
                    }
                });

                document.querySelectorAll('.menu-link').forEach(l=>l.onclick=e=>{
                    if(l.target==='_blank')return; e.preventDefault();
                    document.querySelectorAll('.content-panel').forEach(p=>p.classList.remove('active'));
                    document.getElementById(l.dataset.target).classList.add('active');
                    if(window.innerWidth<=991) { ui.sideMenu.classList.remove('open'); ui.menuToggle.classList.remove('active'); }
                });
                
                document.body.onclick = e => {
                    const edit = e.target.closest('.edit-btn');
                    if(edit) handleShowEditSocioModal(edit.dataset.socioId);
                    const del=e.target.closest('.delete-btn'); if(del) handleDeleteSocio(del.dataset.socioId);
                    const cal=e.target.closest('.calendar-btn'); if(cal) abrirCalendarModal(cal.dataset.socioId, 'PT');
                    const calPlanta=e.target.closest('.calendar-discount-btn'); if(calPlanta) abrirCalendarModal(calPlanta.dataset.socioId, 'PLANTA');
                    const cpt=e.target.closest('.calculate-btn'); if(cpt) abrirPuntosPT(cpt.dataset.socioId);
                    const edA=e.target.closest('.edit-anticipo-btn'); if(edA) handleEditAnt(edA.dataset.socioId, edA.dataset.anticipoIndex);
                    const dlA=e.target.closest('.delete-anticipo-btn'); if(dlA) handleDelAnt(dlA.dataset.socioId, dlA.dataset.anticipoIndex);
                    const edD=e.target.closest('.edit-descuento-btn'); if(edD) handleShowDescuentoModal(edD.dataset.id);
                    const dlD=e.target.closest('.delete-descuento-btn'); if(dlD) handleDelDesc(dlD.dataset.id);
                    const up=e.target.closest('.upload-anticipos-btn'); if(up) handleUpInd(up.dataset.socioId);
                    const down=e.target.closest('.download-anticipos-btn'); if(down) handleDownloadAnticipos(down.dataset.socioId);
                    const editSaldo = e.target.closest('.edit-saldo-anterior-btn'); if(editSaldo) handleEditSaldoAnterior(editSaldo.dataset.socioId);
                };

                [ui.filtroNombre, ui.filtroArea, ui.filtroContrato, ui.filtroNombreGestion, ui.filtroAreaGestion, ui.filtroContratoGestion].forEach(el => {
                    el.addEventListener(el.tagName === 'INPUT' ? 'input' : 'change', renderSociosFiltrados);
                });

                ui.syncDataBtn.onclick=syncData;
                ui.showRegisterSocioModalBtn.onclick=()=>openModal('templateRegisterSocioModal',f=>f.onsubmit=registerSocio);
                ui.addAnticipoBtn=document.getElementById('addAnticipoBtn'); ui.addAnticipoBtn.onclick=openAddAnticipo;
                document.querySelector('.show-punto-planta-btn').onclick=openPuntoPlanta;
                ui.loadAllAnticiposBtn.onclick=handleLoadAllAnticipos;
                ui.uploadAllAnticiposBtn.onclick=handleUploadAllAnticipos;
                ui.saveAllAnticiposAndDistribucionBtn.onclick=handleSaveDistribucionFinal;
                ui.resetAnticiposLocalBtn.onclick=()=>confirmAction('Borrar locales?',()=>{localStorage.removeItem('anticipos_data_v3');updateAllUI();});
                ui.resetPuntoPlantaBtn.onclick=()=>confirmAction('Reset Punto?',()=>{localStorage.removeItem('lastPuntoPlantaValue');updateAllUI();});
                ui.resetPartTimeDataBtn.onclick=()=>confirmAction('Reset PT y Ausencias?',()=>{
                    const d=getStorage('part_time_data_v3'); Object.keys(d).forEach(k=>d[k]={diasTrabajados:[],montoAsignable:0,puntosCalculados:0}); 
                    setStorage('part_time_data_v3',d); 
                    localStorage.removeItem('planta_absences_v1'); 
                    updateAllUI();
                });
            }

            const openModal=(tid, cb)=>{ ui.modalContainer.innerHTML=document.getElementById(tid).innerHTML; const m=ui.modalContainer.querySelector('.modal'); cb(m.querySelector('form'),m); m.querySelector('.close-button').onclick=()=>m.style.display='none'; m.style.display='flex'; };
            const confirmAction=(txt,cb)=>{ ui.modalContainer.innerHTML=document.getElementById('templateConfirmDeleteModal').innerHTML; const m=ui.modalContainer.querySelector('.modal'); m.querySelector('#confirmDeleteText').textContent=txt; m.style.display='flex'; m.querySelector('.cancel-btn').onclick=()=>m.style.display='none'; m.querySelector('.confirm-delete-btn').onclick=()=>{cb();m.style.display='none';showToast('Hecho');};};
            
            async function registerSocio(e) { e.preventDefault(); try{ await apiCall(SCRIPT_URL_SOCIOS,'addSocio','POST',{socio:{Nombre:e.target.nombre.value, Apellido:e.target.apellido.value, FechaIngreso:e.target.fechaIngreso.value, Area:e.target.area.value, TipoContrato:e.target.tipoContrato.value}}); showToast('Ok'); document.querySelector('.modal').style.display='none'; syncData(); }catch(e){showToast(e.message,'danger');} }
            function openAddAnticipo() { openModal('templateAddAnticipoModal', (f,m)=>{
                m.querySelector('#sociosAnticipoList').innerHTML=sociosData.map(s=>`<option value="${s.Nombre} ${s.Apellido}" data-id="${s.ID}">`).join('');
                m.querySelector('#anticipoSocioInput').oninput=e=>{ const o=[...m.querySelectorAll('option')].find(x=>x.value===e.target.value); if(o) m.querySelector('#anticipoSocioId').value=o.dataset.id; };
                setupNumericInputFormatting(f.anticipoCantidad);
                f.onsubmit=e=>{e.preventDefault(); const id=e.target.anticipoSocioId.value; if(!id)return; const l=getStorage('anticipos_data_v3'); if(!l[id])l[id]=[]; l[id].push({fecha:e.target.anticipoFecha.value, cantidad:parseNumber(e.target.anticipoCantidad.value)}); setStorage('anticipos_data_v3',l); updateAllUI(); m.style.display='none';};
            });}
            
            function openPuntoPlanta() {
                openModal('templatePuntoPlantaModal', (f, m) => {
                    const bruto = Object.values(recaudacionPorDia).reduce((a,b)=>a+b,0);
                    const desc = getStorage('descuentos_operacionales_v1');
                    const totalDesc = desc.reduce((s,d)=>s+d.cantidad,0);
                    const neta = bruto - totalDesc;

                    m.querySelector('#propinaNetaModal').textContent = `$${formatNumber(neta)}`;
                    
                    let totalPuntos = 0;
                    const plantaAbs = getStorage('planta_absences_v1');
                    const ptData = getStorage('part_time_data_v3');
                    
                    sociosData.forEach(s => {
                        if(isPartTime(s)) {
                            totalPuntos += s.puntosAntiguedad;
                        } else {
                            let dineroPerdido = 0;
                            (plantaAbs[s.ID]||[]).forEach(dia => dineroPerdido += (recaudacionPorDia[dia] || 0));
                            let factor = bruto > 0 ? (1 - (dineroPerdido / bruto)) : 1;
                            if(factor < 0) factor = 0;
                            totalPuntos += (calcTope(s) * factor);
                        }
                    });

                    m.querySelector('#totalPuntosGeneralDisplay').textContent = totalPuntos.toFixed(2);

                    const divIn = m.querySelector('#divisorManualInput');
                    divIn.value = totalPuntos.toFixed(2).replace('.', ',');

                    const valDisplay = m.querySelector('#valorPuntoCalculadoDisplay');
                    const resultDisplay = m.querySelector('#puntoPlantaValor');

                    const calcular = () => {
                        let valStr = divIn.value.replace(/\./g, '').replace(',', '.');
                        const divisor = parseFloat(valStr);
                        if (divisor > 0) {
                            const valorPunto = neta / divisor;
                            valDisplay.textContent = `$${formatNumber(valorPunto)}`;
                            resultDisplay.textContent = `Valor Real: $${valorPunto.toFixed(2)}`;
                            return valorPunto;
                        } else {
                            valDisplay.textContent = "$0";
                            resultDisplay.textContent = "";
                            return 0;
                        }
                    };

                    divIn.addEventListener('input', calcular);
                    calcular();

                    m.querySelector('#calcularPuntoPlantaInternoBtn').onclick = () => {
                        const punto = calcular();
                        if (punto > 0) {
                            localStorage.setItem('lastPuntoPlantaValue', punto);
                            localStorage.setItem('lastPuntoPlantaDivisor', divIn.value); 
                            updateAllUI();
                            m.style.display = 'none';
                            showToast('Valor Punto establecido.');
                        } else {
                            showToast('El divisor debe ser mayor a 0', 'warning');
                        }
                    };
                });
            }

            async function syncData() { 
                if(isSyncing)return; isSyncing=true; ui.syncIndicator.classList.add('visible'); 
                try{ 
                    await fetchRecaudaciones();
                    await fetchSocios(); 
                    await fetchBalanceFinal(); 
                    updateAllUI(); 
                    showToast('Datos Sincronizados (Propinas + Recaudaciones)'); 
                }catch(e){showToast(e.message,'danger');}
                finally{isSyncing=false;ui.syncIndicator.classList.remove('visible');} 
            }
            
            async function fetchSocios() { const r=await apiCall(SCRIPT_URL_SOCIOS,'getSocios'); sociosData=r.map(s=>({...s, puntosAntiguedad:calcPuntos(s.FechaIngreso), propinaAsignada:0})); const pt=getStorage('part_time_data_v3'); sociosData.filter(isPartTime).forEach(s=>{ if(!pt[s.ID]) pt[s.ID]={diasTrabajados:[],montoAsignable:0}; recalcularMontoAsignableParaSocio(s); }); }
            async function fetchBalanceFinal() { try{ultimaDistribucionData=await apiCall(SCRIPT_URL_SOCIOS,'getUltimaDistribucion');}catch(e){} }
            function recalcularMontoAsignableParaSocio(s){ if(!isPartTime(s))return; const pt=getStorage('part_time_data_v3'); const d=pt[s.ID]||{}; let m=0; (d.diasTrabajados||[]).forEach(dia=>{ m += (recaudacionPorDia[dia] || 0); }); pt[s.ID]={...d,montoAsignable:m}; setStorage('part_time_data_v3',pt); }

            function handleDeleteSocio(id){ confirmAction('Eliminar?',async()=>{ await apiCall(SCRIPT_URL_SOCIOS,'deleteSocio','POST',{socioId:id}); syncData(); }); }
            function handleEditAnt(id,idx){ openModal('templateEditAnticipoModal',(f,m)=>{ const a=getStorage('anticipos_data_v3')[id][idx]; f.editAnticipoFecha.value=a.fecha; f.editAnticipoCantidad.value=formatNumber(a.cantidad); f.onsubmit=e=>{e.preventDefault(); const l=getStorage('anticipos_data_v3'); l[id][idx]={fecha:f.editAnticipoFecha.value, cantidad:parseNumber(f.editAnticipoCantidad.value)}; setStorage('anticipos_data_v3',l); updateAllUI(); m.style.display='none'; } }); }
            function handleDelAnt(id,idx){ confirmAction('Borrar anticipo?',()=>{ const l=getStorage('anticipos_data_v3'); l[id].splice(idx,1); setStorage('anticipos_data_v3',l); updateAllUI(); }); }
            function handleShowDescuentoModal(id=null){ openModal('templateAddDescuentoModal',(f,m)=>{ setupNumericInputFormatting(f.descuentoCantidad); if(id){ const d=getStorage('descuentos_operacionales_v1').find(x=>x.id==id); f.descuentoId.value=d.id; f.descuentoDescripcion.value=d.descripcion; f.descuentoCantidad.value=formatNumber(d.cantidad); } f.onsubmit=e=>{e.preventDefault(); const l=getStorage('descuentos_operacionales_v1'); const obj={id:f.descuentoId.value||Date.now(), categoria:f.descuentoCategoria.value, descripcion:f.descuentoDescripcion.value, cantidad:parseNumber(f.descuentoCantidad.value)}; const idx=l.findIndex(x=>x.id==obj.id); if(idx>-1)l[idx]=obj; else l.push(obj); setStorage('descuentos_operacionales_v1',l); updateAllUI(); m.style.display='none'; }; }); }
            function handleDelDesc(id){ confirmAction('Borrar dcto?',()=>{ const l=getStorage('descuentos_operacionales_v1').filter(x=>x.id!=id); setStorage('descuentos_operacionales_v1',l); updateAllUI(); }); }
            function handleUpInd(id){ handleUploadAllAnticipos(); } 
            function handleDownInd(id){ handleDownloadAnticipos(id); }
            
            // CALENDARIO CON CALCULO MONETARIO EN TIEMPO REAL
            function abrirCalendarModal(id, mode) { 
                const s=sociosData.find(x=>x.ID===id); 
                ui.modalContainer.innerHTML=document.getElementById('templateCalendarModal').innerHTML; 
                const m=ui.modalContainer.querySelector('.modal'); 
                m.querySelector('#calendarModalTitle').textContent = mode === 'PT' ? 'D√≠as Trabajados (PT)' : 'D√≠as Ausencia (Planta)';
                
                const infoText = m.querySelector('#montoDescuentoInfo');
                let dias = mode === 'PT' ? (getStorage('part_time_data_v3')[id]||{}).diasTrabajados||[] : getStorage('planta_absences_v1')[id]||[];

                m.querySelector('#selectedDaysCount').textContent=dias.length; 
                
                // Funci√≥n interna para calcular valor de la selecci√≥n actual
                const updateMontoSeleccion = (selectedDates) => {
                    let total = 0;
                    selectedDates.forEach(dObj => {
                        const dateStr = flatpickrInstance.formatDate(dObj, "Y-m-d");
                        total += (recaudacionPorDia[dateStr] || 0);
                    });
                    if(mode === 'PLANTA') {
                        infoText.style.display = 'block';
                        infoText.textContent = `Total a Descontar: $${formatNumber(total)}`;
                    } else {
                        infoText.style.display = 'block';
                        infoText.style.color = '#27ae60';
                        infoText.textContent = `Total a Pagar: $${formatNumber(total)}`;
                    }
                    m.querySelector('#selectedDaysCount').textContent = selectedDates.length;
                };

                flatpickrInstance=flatpickr(m.querySelector('#flatpickrInput'), {
                    mode: "multiple", dateFormat: "Y-m-d", defaultDate: dias,
                    onChange: updateMontoSeleccion,
                    onOpen: () => updateMontoSeleccion(flatpickrInstance.selectedDates) // Calc inicial
                }); 
                
                m.querySelector('#saveCalendarBtn').onclick = () => { 
                    const sel = flatpickrInstance.selectedDates.map(d=>flatpickrInstance.formatDate(d,"Y-m-d"));
                    if(mode === 'PT') {
                        const pt = getStorage('part_time_data_v3');
                        pt[id] = { ...(pt[id]||{}), diasTrabajados: sel }; 
                        setStorage('part_time_data_v3', pt); 
                        recalcularMontoAsignableParaSocio(s); 
                    } else {
                        const abs = getStorage('planta_absences_v1');
                        abs[id] = sel;
                        setStorage('planta_absences_v1', abs);
                    }
                    showToast('Guardado.'); updateAllUI(); m.style.display='none';
                };
                m.querySelector('.close-button').onclick=()=>m.style.display='none'; m.style.display='flex'; 
            }

            function abrirPuntosPT(id){ openModal('templatePartTimePointsModal',(f,m)=>{ const pt=getStorage('part_time_data_v3')[id]||{}; m.querySelector('#partTimeModalAssignableAmount').textContent=`$${formatNumber(pt.montoAsignable)}`; m.querySelector('#calculatePartTimePointsInternoBtn').onclick=()=>{ const div=parseNumber(m.querySelector('#partTimeMultiplicador').value); if(div>0){ pt.puntosCalculados=pt.montoAsignable/div; const d=getStorage('part_time_data_v3'); d[id]=pt; setStorage('part_time_data_v3',d); updateAllUI(); m.style.display='none'; } }; }); }

            setupEventListeners();
            syncData();
        });
    </script>
</body>
</html>
